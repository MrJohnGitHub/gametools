--功能投资的配置
--奖励配置,类型（0物品1金币2绑金3经验29boss积分100绑元101元宝，奖励id，数量，绑定（1绑定0非绑）
G_Investment_Config = {	
	--修炼
	[1] = 
	{
		tips = "修炼投资",
		start_time = {year = 2016, month = 11, day = 15, hour = 0, min = 0, sec = 0},
		end_time = {year = 2016, month = 11, day = 19, hour = 23, min = 59, sec = 59},
		open_ser_tm = {
		start_day = 8,
		end_day = 11,
		},
		use_open = false,
		money = 3888,
		reward = {
			[1] = {0,12022,2,1},
			[2] = {0,12022,1,1},
			[3] = {0,12022,1,1},
			[4] = {0,12022,1,1},
			[5] = {0,12022,1,1},
			[6] = {0,12022,1,1},
			[7] = {0,12022,1,1},
			[8] = {0,12022,1,1},
			[9] = {0,12022,1,1},
			[10] = {0,12022,2,1}
		}
	},

	--转生
	[2] = 
	{
		tips = "转生投资",
		start_time = {year = 9999, month = 11, day = 14, hour = 0, min = 0, sec = 0},
		end_time = {year = 9999, month = 11, day = 28, hour = 23, min = 59, sec = 59},
		money = 3888,
		open_ser_tm = 
		{
		start_day = 8,
		end_day = 11,
		},
		use_open = false,
		reward = {
			[1] = {0,40101,30,1},
			[2] = {0,40101,30,1},
			[3] = {0,40101,30,1},
			[4] = {0,40101,30,1},
			[5] = {0,40101,30,1},
			[6] = {0,40101,30,1},
			[7] = {0,40101,30,1},
			[8] = {0,40101,30,1},
			[9] = {0,40101,30,1},
			[10] = {0,40101,30,1}
		}
	},
	
	--神翼
	[3] = 
	{
		tips = "神翼投资",
		start_time = {year = 2016, month = 11, day = 15, hour = 0, min = 0, sec = 0},
		end_time = {year = 2016, month = 11, day = 19, hour = 23, min = 59, sec = 59},
		money = 3888,
		open_ser_tm = 
		{
			start_day = 8,
			end_day = 11,
		},
		use_open = false,
		reward = {
			[1] = {0,40101,60,1},
			[2] = {0,40101,60,1},
			[3] = {0,40101,30,1},
			[4] = {0,40101,30,1},
			[5] = {0,40101,30,1},
			[6] = {0,40101,30,1},
			[7] = {0,40101,30,1},
			[8] = {0,40101,30,1},
			[9] = {0,40101,30,1},
			[10] = {0,40101,60,1}
		}
	},

	--坐骑
	[4] = 
	{
		tips = "坐骑投资",
		start_time = {year = 9999, month = 11, day = 14, hour = 0, min = 0, sec = 0},
		end_time = {year = 9999, month = 11, day = 28, hour = 23, min = 59, sec = 59},
		money = 3888,
		open_ser_tm = 
		{
		start_day = 8,
		end_day = 11,
		},
	use_open = false,
		reward = {
			[1] = {0,10028,1,1},
			[2] = {0,10028,1,1},
			[3] = {0,10028,1,1},
			[4] = {0,10028,1,1},
			[5] = {0,10028,1,1},
			[6] = {0,10028,1,1},
			[7] = {0,10028,1,1},
			[8] = {0,10028,1,1},
			[9] = {0,10028,1,1},
			[10] = {0,10028,1,1}
		}
	},
	
	--符文
	[5] = 
	{
		tips = "符文投资",
		start_time = {year = 8888, month = 11, day = 15, hour = 0, min = 0, sec = 0},
		end_time = {year = 8888, month = 11, day = 24, hour = 23, min = 59, sec = 59},
		money = 3888,
		open_ser_tm = 
		{
		start_day = 8,
		end_day = 11,
		},
	use_open = false,
		reward = {
			[1] = {0,40805,2,1},
			[2] = {0,40805,2,1},
			[3] = {0,40805,2,1},
			[4] = {0,40805,2,1},
			[5] = {0,40805,2,1},
			[6] = {0,40805,2,1},
			[7] = {0,40805,2,1},
			[8] = {0,40805,2,1},
			[9] = {0,40805,2,1},
			[10] = {0,40805,2,1}
		}
	},

	--精魄
	[6] = 
	{
		tips = "精魄投资",
		start_time = {year = 2016, month = 11, day = 15, hour = 0, min = 0, sec = 0},
		end_time = {year = 2016, month = 11, day = 19, hour = 23, min = 59, sec = 59},
		money = 3888,
		open_ser_tm = 
		{
		start_day = 8,
		end_day = 11,
		},
		use_open = false,
		reward = {
			[1] = {0,10413,2,1},
			[2] = {0,10413,1,1},
			[3] = {0,10413,1,1},
			[4] = {0,10413,1,1},
			[5] = {0,10413,1,1},
			[6] = {0,10413,1,1},
			[7] = {0,10413,1,1},
			[8] = {0,10413,1,1},
			[9] = {0,10413,1,1},
			[10] = {0,10413,2,1}
		}
	},

	--血玉
	[7] = 
	{
		tips = "血玉投资",
		start_time = {year = 9999, month = 11, day = 14, hour = 0, min = 0, sec = 0},
		end_time = {year = 9999, month = 11, day = 28, hour = 23, min = 59, sec = 59},
		money = 3888,
		open_ser_tm = 
		{
		start_day = 8,
		end_day = 11,
		},
		use_open = false,
		reward = {
			[1] = {0,10028,1,1},
			[2] = {0,10028,1,1},
			[3] = {0,10028,1,1},
			[4] = {0,10028,1,1},
			[5] = {0,10028,1,1},
			[6] = {0,10028,1,1},
			[7] = {0,10028,1,1},
			[8] = {0,10028,1,1},
			[9] = {0,10028,1,1},
			[10] = {0,10028,1,1}
		}
	},
	
	--神盾
	[8] = 
	{
		tips = "神盾投资",
		start_time = {year = 9999, month = 11, day = 14, hour = 0, min = 0, sec = 0},
		end_time = {year = 9999, month = 11, day = 28, hour = 23, min = 59, sec = 59},
		money = 3888,
		open_ser_tm = 
		{
		start_day = 8,
		end_day = 11,
		},
		use_open = false,
		reward = {
			[1] = {0,10028,1,1},
			[2] = {0,10028,1,1},
			[3] = {0,10028,1,1},
			[4] = {0,10028,1,1},
			[5] = {0,10028,1,1},
			[6] = {0,10028,1,1},
			[7] = {0,10028,1,1},
			[8] = {0,10028,1,1},
			[9] = {0,10028,1,1},
			[10] = {0,10028,1,1}
		}
	},
	
	--宝石
	[9] = 
	{
		tips = "宝石投资",
		start_time = {year = 2016, month = 11, day = 15, hour = 0, min = 0, sec = 0},
		end_time = {year = 2016, month = 11, day = 19, hour = 23, min = 59, sec = 59},
		money = 3888,
		open_ser_tm = 
		{
			start_day = 8,
			end_day = 11,
		},
		use_open = false,
		reward = {
			[1] = {0,10410,2,1},
			[2] = {0,10410,1,1},
			[3] = {0,10410,1,1},
			[4] = {0,10410,1,1},
			[5] = {0,10410,1,1},
			[6] = {0,10410,1,1},
			[7] = {0,10410,1,1},
			[8] = {0,10410,1,1},
			[9] = {0,10410,1,1},
			[10] = {0,10410,2,1}
		}
	},
	--魂珠
	[10] = 
	{
		tips = "魂珠投资",
		start_time = {year = 2016, month = 11, day = 15, hour = 0, min = 0, sec = 0},
		end_time = {year = 2016, month = 11, day = 19, hour = 23, min = 59, sec = 59},
		money = 3888,
		open_ser_tm = {
			start_day = 8,
			end_day = 11,
		},
		use_open = false,
		reward = {
			[1] = {0,10408,1,1},
			[2] = {0,10408,1,1},
			[3] = {0,10408,1,1},
			[4] = {0,10408,1,1},
			[5] = {0,10408,1,1},
			[6] = {0,10408,1,1},
			[7] = {0,10408,1,1},
			[8] = {0,10408,1,1},
			[9] = {0,10408,1,1},
			[10] = {0,10408,1,1}
		}
	},
	
	--特戒
	[11] = 
	{
		tips = "特戒投资",
		start_time = {year = 9999, month = 11, day = 14, hour = 0, min = 0, sec = 0},
		end_time = {year = 9999, month = 11, day = 28, hour = 23, min = 59, sec = 59},
		money = 3888,
		open_ser_tm = {
			start_day = 8,
			end_day = 11,
		},
		use_open = false,
		reward = {
			[1] = {0,12022,1,1},
			[2] = {0,12022,1,1},
			[3] = {0,12022,1,1},
			[4] = {0,12022,1,1},
			[5] = {0,12022,1,1},
			[6] = {0,12022,1,1},
			[7] = {0,12022,1,1},
			[8] = {0,12022,1,1},
			[9] = {0,12022,1,1},
			[10] = {0,12022,1,1}
		}
	},
	
		--熔炼
	[12] = 
	{
		tips = "熔炼投资",
		start_time = {year = 8888, month = 11, day = 15, hour = 0, min = 0, sec = 0},
		end_time = {year = 8888, month = 11, day = 24, hour = 23, min = 59, sec = 59},
		money = 3888,
		open_ser_tm = {
			start_day = 8,
			end_day = 11,
		},
		use_open = false,
		reward = {
			[1] = {0,40901,5,1},
			[2] = {0,40901,5,1},
			[3] = {0,40901,5,1},
			[4] = {0,40901,5,1},
			[5] = {0,40901,5,1},
			[6] = {0,40901,5,1},
			[7] = {0,40901,5,1},
			[8] = {0,40901,5,1},
			[9] = {0,40901,5,1},
			[10] = {0,40901,5,1}
		}
	}
};

function OnInvestmentInfo(player,id)
	local obj = {};
	local mar = {};
	local len = #G_Investment_Config;
	for i = 1,len do
		local config = G_Investment_Config[i];
		local max_day =  #config.reward;
		local start, over = GetActivityStartAndOverTimeStamp(config);
		local cur = os.time()
		local param_1 = player:get_param(695+i);
		local param_2 = player:get_param(707+i);
		if start <= cur and cur < over then
			if param_1 > start and param_1 < over then
				local target = {};
				target.id = i;
				target.start_time = start;
				target.end_time   = over;
				target.has_buy    = param_1;	
				target.award_flag = param_2;
				target.days = GetTodayIsWhichDay(param_1);
				if target.days > max_day then
					target.days = max_day
				end
				table.insert(mar,target);
			else
				local target = {};
				target.id = i;
				target.start_time = start;
				target.end_time   = over;
				target.has_buy    = 0;	
				player:set_param(695+i,0);
				player:set_param(707+i,0);
				target.award_flag = 0;
				target.days = 0;
				table.insert(mar,target);
			end
		else
			if param_1 ~= 0 then
				for j = 1,max_day do
					if bitget(param_2,j) == 0 then
						local target = {};
						target.id = i;
						target.start_time = start;
						target.end_time   = over;
						target.has_buy    = param_1;	
						target.award_flag = param_2;
						target.days = GetTodayIsWhichDay(param_1);
						if target.days > max_day then
							target.days = max_day
						end	
						table.insert(mar,target);
						break;
					end
				end
			end
		end
	end
	obj.list = mar;
	player:SendPacketToSelf(4651,0,encode(obj));
end

function OnBuyInvestment(player,type,id)
	local config = G_Investment_Config[type];
	if config == nil then
		return;
	end
	local start, over = GetActivityStartAndOverTimeStamp(config);
	local cur = os.time()
	local param_1 = player:get_param(695+type);
	if start < param_1 and param_1 < over then
		player:alert(10,0,0,"您已经购买了");
		return
	end
	if start > cur or cur >= over then
		player:alert(10,0,0,"不在活动期间内,不能购买");
		return
	end
	if player:get_vcoin() < config.money then
		player:alert(10,0,0,"元宝不足");
		return;
	end 
	player:sub_vcoin(config.money);
	player:set_param(695+type,cur);
	player:set_param(707+type,0);
	
	local obj = {};
	obj.id = type;
	obj.start_time = start;
	obj.end_time   = over;
	obj.has_buy    = cur;
	obj.award_flag = 0;
	obj.days = 1;
	player:SendPacketToSelf(4652,0,encode(obj));
	g_broadcast(12,0,0,"<font color='#00ccff'>"..player:GetName().."</font>参与了<font color='#00ccff'>"..config["tips"].."</font>，一折获取珍贵材料！<font color='#0be140'>{_showSysWin,我也要投资,Open_MatInves,1}</font>");
end

function OnInvestmentReward(player,type, day,id)
	local config = G_Investment_Config[type];
	if config == nil then
		return;
	end
	local start, over = GetActivityStartAndOverTimeStamp(config);
	local cur = os.time()
	local param_1 = player:get_param(695+type);
	if param_1 == 0 then
		return;
	end
	local days = GetTodayIsWhichDay(param_1);
	local max_day =  #config.reward;
	if days > max_day then
		days = max_day
	end		
	local param_2 = player:get_param(707+type);
	if day > days or day > max_day or day < 1 then
		return
	end
	if bitget(param_2,day) == 1 then
		player:alert(10,0,0,"您已经领取过了");
		return
	end
	if player:num_bag_black() < 1 then
		player:alert(10,0,0,"背包空间不足，请及时处理");
		return;
	end
	param_2 = bitset(param_2,day);
	new_add_item(player,config.reward[day][1],config.reward[day][2],config.reward[day][3],config.reward[day][4],0);
	player:set_param(707+type,param_2);
	local obj = {};
	obj.id = type;
	obj.start_time = start;
	obj.end_time   = over;
	obj.has_buy    = cur;
	obj.award_flag = param_2;
	obj.days = days;
	player:SendPacketToSelf(4653,0,encode(obj));
end