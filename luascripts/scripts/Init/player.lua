
local hjtabe = {
[1100]={0,0,0,0,0,0,0,0,0,0,0,0},
[1101]={15000,11,20,11,20,11,20,0,0,0,0,0},
[1102]={20000,24,44,24,44,24,44,0,0,0,0,0},
[1103]={40000,24,44,24,44,24,44,6,21,0,0,0},
[1104]={60000,39,77,40,77,40,77,6,21,0,0,0},
[1105]={100000,39,77,40,77,40,77,13,46,0,0,0},
[1106]={150000,55,111,56,111,56,111,13,46,0,0,0},
[1107]={207000,55,111,56,111,56,111,24,84,0,0,0},
[1108]={250000,74,147,75,147,75,147,24,84,0,0,0},
[1109]={401000,74,147,75,147,75,147,24,84,59,111,0},
[1110]={455000,74,147,75,147,75,147,24,84,131,245,0},
[1111]={656000,74,147,75,147,75,147,71,146,131,245,0},
[1112]={750000,94,189,95,189,95,189,71,146,131,245,0},
[1201]={950000,120,240,121,240,121,240,71,146,131,245,0},
[1202]={1000000,148,297,149,297,149,297,71,146,131,245,0},
[1203]={1256000,148,297,149,297,149,297,71,146,131,245,2485},
[1204]={1500000,187,374,188,374,188,374,71,146,131,245,2485},
[1205]={1756000,187,374,188,374,188,374,71,146,213,362,2485},
[1206]={2000000,238,497,239,497,239,497,71,146,213,362,2485},
[1207]={2309000,238,497,239,497,239,497,71,146,213,362,5468},
[1208]={2510000,321,624,322,624,322,624,71,146,213,362,5468},
[1209]={3010000,419,789,420,789,420,789,71,146,213,362,5468},
[1210]={3515000,525,967,526,967,526,967,71,146,213,362,5468},
[1211]={3750000,525,967,526,967,526,967,71,146,213,362,9549},
[1212]={4005000,646,1154,647,1154,647,1154,71,146,213,362,9549},
[1301]={4257000,775,1354,776,1354,776,1354,71,146,213,362,9549},
[1302]={4507000,775,1354,776,1354,776,1354,71,146,321,534,9549},
[1303]={5207000,934,1557,935,1557,935,1557,71,146,321,534,9549},
[1304]={5530000,934,1557,935,1557,935,1557,71,146,433,719,9549},
[1305]={6082000,1100,1764,1101,1764,1101,1764,71,146,433,719,9549},
[1306]={6585000,1100,1764,1101,1764,1101,1764,71,146,433,719,14443},
[1307]={7023000,1272,1989,1273,1989,1273,1989,71,146,433,719,14443},
[1308]={6825000,1272,1989,1273,1989,1273,1989,71,146,572,948,14443},
[1309]={8081000,1445,2252,1446,2252,1446,2252,71,146,572,948,14443},
[1310]={8505000,1445,2252,1446,2252,1446,2252,71,146,572,948,20317},
[1311]={9063000,1445,2252,1446,2252,1446,2252,71,146,775,1272,20317},
[1312]={9565000,1625,2535,1626,2535,1626,2535,71,146,775,1272,20317},
[1401]={10386000,1809,2823,1810,2823,1810,2823,71,146,775,1272,20317},
[1402]={12390000,2003,3128,2004,3128,2004,3128,71,146,775,1272,20317},
[1403]={14861000,2003,3128,2004,3128,2004,3128,71,146,775,1272,32634},
[1404]={16865000,2204,3444,2205,3444,2205,3444,71,146,775,1272,32634},
[1405]={18521000,2413,3771,2414,3771,2414,3771,71,146,775,1272,32634},
[1406]={20525000,2630,4110,2631,4110,2631,4110,71,146,775,1272,32634},
[1407]={22387000,2854,4461,2855,4461,2855,4461,71,146,775,1272,32634},
[1408]={24391000,3086,4823,3087,4823,3087,4823,71,146,775,1272,32634},
[1409]={26496000,3326,5198,3327,5198,3327,5198,71,146,775,1272,32634},
[1410]={28500000,3574,5584,3575,5584,3575,5584,71,146,775,1272,32634},
[1411]={30500000,3831,5983,3832,5983,3832,5983,71,146,775,1272,32634},
[1412]={33562000,4235,6454,4236,6454,4236,6454,71,146,775,1272,32634},
[2100]={0,0,0,0,0,0,0,0,0,0,0,0},
[2101]={15000,11,20,11,20,11,20,0,0,0,0,0},
[2102]={20000,24,44,24,44,24,44,0,0,0,0,0},
[2103]={40000,24,44,24,44,24,44,6,21,0,0,0},
[2104]={60000,39,77,40,77,40,77,6,21,0,0,0},
[2105]={100000,39,77,40,77,40,77,13,46,0,0,0},
[2106]={150000,55,111,56,111,56,111,13,46,0,0,0},
[2107]={207000,55,111,56,111,56,111,24,84,0,0,0},
[2108]={250000,74,147,75,147,75,147,24,84,0,0,0},
[2109]={401000,74,147,75,147,75,147,24,84,59,111,0},
[2110]={455000,74,147,75,147,75,147,24,84,131,245,0},
[2111]={656000,74,147,75,147,75,147,71,146,131,245,0},
[2112]={750000,94,189,95,189,95,189,71,146,131,245,0},
[2201]={950000,120,240,121,240,121,240,71,146,131,245,0},
[2202]={1000000,148,297,149,297,149,297,71,146,131,245,0},
[2203]={1256000,148,297,149,297,149,297,71,146,131,245,953},
[2204]={1500000,187,374,188,374,188,374,71,146,131,245,953},
[2205]={1756000,187,374,188,374,188,374,71,146,213,362,953},
[2206]={2000000,238,497,239,497,239,497,71,146,213,362,953},
[2207]={2309000,238,497,239,497,239,497,71,146,213,362,2097},
[2208]={2510000,321,624,322,624,322,624,71,146,213,362,2097},
[2209]={3010000,419,789,420,789,420,789,71,146,213,362,2097},
[2210]={3515000,525,967,526,967,526,967,71,146,213,362,2097},
[2211]={3750000,525,967,526,967,526,967,71,146,213,362,3662},
[2212]={4005000,646,1154,647,1154,647,1154,71,146,213,362,3662},
[2301]={4257000,775,1354,776,1354,776,1354,71,146,213,362,3662},
[2302]={4507000,775,1354,776,1354,776,1354,71,146,321,534,3662},
[2303]={5207000,934,1557,935,1557,935,1557,71,146,321,534,3662},
[2304]={5530000,934,1557,935,1557,935,1557,71,146,433,719,3662},
[2305]={6082000,1100,1764,1101,1764,1101,1764,71,146,433,719,3662},
[2306]={6585000,1100,1764,1101,1764,1101,1764,71,146,433,719,5539},
[2307]={7023000,1272,1989,1273,1989,1273,1989,71,146,433,719,5539},
[2308]={6825000,1272,1989,1273,1989,1273,1989,71,146,572,948,5539},
[2309]={8081000,1445,2252,1446,2252,1446,2252,71,146,572,948,5539},
[2310]={8505000,1445,2252,1446,2252,1446,2252,71,146,572,948,7792},
[2311]={9063000,1445,2252,1446,2252,1446,2252,71,146,775,1272,7792},
[2312]={9565000,1625,2535,1626,2535,1626,2535,71,146,775,1272,7792},
[2401]={10386000,1809,2823,1810,2823,1810,2823,71,146,775,1272,7792},
[2402]={12390000,2003,3128,2004,3128,2004,3128,71,146,775,1272,7792},
[2403]={14861000,2003,3128,2004,3128,2004,3128,71,146,775,1272,12516},
[2404]={16865000,2204,3444,2205,3444,2205,3444,71,146,775,1272,12516},
[2405]={18521000,2413,3771,2414,3771,2414,3771,71,146,775,1272,12516},
[2406]={20525000,2630,4110,2631,4110,2631,4110,71,146,775,1272,12516},
[2407]={22387000,2854,4461,2855,4461,2855,4461,71,146,775,1272,12516},
[2408]={24391000,3086,4823,3087,4823,3087,4823,71,146,775,1272,12516},
[2409]={26496000,3326,5198,3327,5198,3327,5198,71,146,775,1272,12516},
[2410]={28500000,3574,5584,3575,5584,3575,5584,71,146,775,1272,12516},
[2411]={30500000,3831,5983,3832,5983,3832,5983,71,146,775,1272,12516},
[2412]={33562000,4235,6454,4236,6454,4236,6454,71,146,775,1272,12516},
[3100]={0,0,0,0,0,0,0,0,0,0,0,0},
[3101]={15000,11,20,11,20,11,20,0,0,0,0,0},
[3102]={20000,24,44,24,44,24,44,0,0,0,0,0},
[3103]={40000,24,44,24,44,24,44,6,21,0,0,0},
[3104]={60000,39,77,40,77,40,77,6,21,0,0,0},
[3105]={100000,39,77,40,77,40,77,13,46,0,0,0},
[3106]={150000,55,111,56,111,56,111,13,46,0,0,0},
[3107]={207000,55,111,56,111,56,111,24,84,0,0,0},
[3108]={250000,74,147,75,147,75,147,24,84,0,0,0},
[3109]={401000,74,147,75,147,75,147,24,84,59,111,0},
[3110]={455000,74,147,75,147,75,147,24,84,131,245,0},
[3111]={656000,74,147,75,147,75,147,71,146,131,245,0},
[3112]={750000,94,189,95,189,95,189,71,146,131,245,0},
[3201]={950000,120,240,121,240,121,240,71,146,131,245,0},
[3202]={1000000,148,297,149,297,149,297,71,146,131,245,0},
[3203]={1256000,148,297,149,297,149,297,71,146,131,245,1823},
[3204]={1500000,187,374,188,374,188,374,71,146,131,245,1823},
[3205]={1756000,187,374,188,374,188,374,71,146,213,362,1823},
[3206]={2000000,238,497,239,497,239,497,71,146,213,362,1823},
[3207]={2309000,238,497,239,497,239,497,71,146,213,362,4011},
[3208]={2510000,321,624,322,624,322,624,71,146,213,362,4011},
[3209]={3010000,419,789,420,789,420,789,71,146,213,362,4011},
[3210]={3515000,525,967,526,967,526,967,71,146,213,362,4011},
[3211]={3750000,525,967,526,967,526,967,71,146,213,362,7004},
[3212]={4005000,646,1154,647,1154,647,1154,71,146,213,362,7004},
[3301]={4257000,775,1354,776,1354,776,1354,71,146,213,362,7004},
[3302]={4507000,775,1354,776,1354,776,1354,71,146,321,534,7004},
[3303]={5207000,934,1557,935,1557,935,1557,71,146,321,534,7004},
[3304]={5530000,934,1557,935,1557,935,1557,71,146,433,719,7004},
[3305]={6082000,1100,1764,1101,1764,1101,1764,71,146,433,719,7004},
[3306]={6585000,1100,1764,1101,1764,1101,1764,71,146,433,719,10594},
[3307]={7023000,1272,1989,1273,1989,1273,1989,71,146,433,719,10594},
[3308]={6825000,1272,1989,1273,1989,1273,1989,71,146,572,948,10594},
[3309]={8081000,1445,2252,1446,2252,1446,2252,71,146,572,948,10594},
[3310]={8505000,1445,2252,1446,2252,1446,2252,71,146,572,948,14903},
[3311]={9063000,1445,2252,1446,2252,1446,2252,71,146,775,1272,14903},
[3312]={9565000,1625,2535,1626,2535,1626,2535,71,146,775,1272,14903},
[3401]={10386000,1809,2823,1810,2823,1810,2823,71,146,775,1272,14903},
[3402]={12390000,2003,3128,2004,3128,2004,3128,71,146,775,1272,14903},
[3403]={14861000,2003,3128,2004,3128,2004,3128,71,146,775,1272,23939},
[3404]={16865000,2204,3444,2205,3444,2205,3444,71,146,775,1272,23939},
[3405]={18521000,2413,3771,2414,3771,2414,3771,71,146,775,1272,23939},
[3406]={20525000,2630,4110,2631,4110,2631,4110,71,146,775,1272,23939},
[3407]={22387000,2854,4461,2855,4461,2855,4461,71,146,775,1272,23939},
[3408]={24391000,3086,4823,3087,4823,3087,4823,71,146,775,1272,23939},
[3409]={26496000,3326,5198,3327,5198,3327,5198,71,146,775,1272,23939},
[3410]={28500000,3574,5584,3575,5584,3575,5584,71,146,775,1272,23939},
[3411]={30500000,3831,5983,3832,5983,3832,5983,71,146,775,1272,23939},
[3412]={33562000,4235,6454,4236,6454,4236,6454,71,146,775,1272,23939}
}

function bitget(a, b)
	return math.floor(a/(2^(b-1))) % 2;
end

function bitset(a, b)
	local c = 2^(b-1);
	if (math.floor(a/c) % 2 == 0) then
		a = a + c;
	end

	return a;
end

function ubitset(a, b)
	local c = 2^(b-1);
	if (math.floor(a/c) % 2 == 1) then
		a = a - c;
	end

	return a;
end

function getnextweek()
	local week = tonumber(os.date("%w",os.time()));
	local weeknext = 1;
	if week > 0 then
		weeknext = 8 - week;
	end   
	local time_0 = os.time({year=os.date("%Y"),month=os.date("%m"),day=os.date("%d"),hour = 0});
	return  time_0 + weeknext * 86400 - 1;
end
function getnextmonth()   
	return os.time({year=os.date("%Y"),month=os.date("%m")+1,day=1,hour=0}) - 1;
end
function today()
	return math.floor((os.time()+8*60*60)/(60*60*24));
end

function SendAwaredNotice(player)
	local flag = 0;
	local level = player:GetLevel();
	if level >= 60 then
		local isSignIn = player:get_param(412);
		local totalSignInDays = player:get_param(411);
		if isSignIn == 0 and totalSignInDays < 28 then
			flag = 1;
		else		
			local giftIndex = player:get_param(344);
			for i=1,5 do
				if bitget(giftIndex,i) == 0 and totalSignInDays >= g_totalsigntabe[i][1] then
					flag = 2;
					break;
				end
			end
		end
		if flag == 0 then
			local param413 = player:get_param(413);
			local pass = player:get_online_time();
			for i=1,#g_onlinetabe do
				if bitget(param413,i) == 0 and pass >= g_onlinetabe[i][1] then
					flag = 3;
					break;
				end
			end
		end
		if flag == 0 then
			local lastreward = math.floor(player:get_param(376) / 3600);
			local nowweek = g_getWeek();
			if nowweek > 1 and lastreward > 0 then
				flag = 4;
			end
		end
	end
	if level >= 60 then
		if flag == 0 then
			local offtime = math.floor(player:get_param(380) / 3600);
			if offtime > 0 then
				flag = 6;
			end
		end
	end
	
	local obj = {};
	obj.id = 7;
	obj.ret = flag;
	player:SendPacketToSelf(2437,0,encode(obj));	
end

function SevenDayRewardList(player)
--	local daynum = g_get_day();
	local daynum = player:get_login_days();
	local param422 = player:get_param(422);
	local mrobj = {};
	local obj = {};
	mrobj.loginday = daynum;
	mrobj.getList = param422;
	player:SendPacketToSelf(2425,0,encode(mrobj));
--	SendAwaredNotice(player);
end

function SetSpecialItemTimes(player)
	local itemtb = {
			{10287,438},{10274,438},{10275,438},{10276,438},{10277,438},{10285,438},{10286,438},{10288,438},{10279,439},
			{10151,610},{10152,611},{10153,612},{10154,613},{10246,619},{10247,620},{12021,621},{12022,622},{31301,623}
		};
    local tar = {};
	for i=1,#itemtb do
		local item_obj= {};
	    item_obj.id = itemtb[i][1];
	    item_obj.times = player:get_param(itemtb[i][2]);
	    table.insert(tar,item_obj);
    end
    player:SendPacketToSelf(1725,0,encode(tar));
end

function onEnterGame1(event,player)		--玩家第1次进入世界触发
--	player:show_npc_flags(1001,1);
	player:set_task_state(1,2);
	player:push_task_data(1,1);

	player:set_param(378,getnextweek());		--下次每周更新（每周一）
	player:set_param(379,getnextmonth());		--下次每月更新（每月第一天）
	
	player:set_task_param(470,1,0);
	player:set_param(201,math.random(1,5));
	player:set_param(202,math.random(1,5));
	
	SendAwaredNotice(player);
	--==================封号=====================
	player:set_param(400,bitset(player:get_param(400),1));
	player:set_param(400,bitset(player:get_param(400),2));
	player:set_param(400,bitset(player:get_param(400),3));
	player:set_param(400,bitset(player:get_param(400),4));
	player:set_param(400,bitset(player:get_param(400),5));
	player:set_param(400,bitset(player:get_param(400),6));
end

function OnGetFuBenNum(player, type)
    local nparam = 0;   
    local vparam = 0;
    local obj = {};
    local arra = {};
	local paramConf = {
		[249] = 355,
		[257] = 356,
		[258] = 357,
		[259] = 358,
		[437] = 375,
		[260] = 675,
		[261] = 674
	}

	for k, v in pairs(paramConf) do
		local todayEnter = player:get_param(v)
		local todayBuy = player:get_task_param(v,0)
		local dayLimit = g_buymapentertime[k] and g_buymapentertime[k].daylimit or 0
		local leftEnter = g_mapentern[k][1] - todayEnter
		if leftEnter < 0 then
			leftEnter = 0
		end
		local leftBuy = dayLimit - todayBuy
		if leftBuy < 0 then
			leftBuy = 0
		end
		local info = {
			mapid = k, 
			num = leftEnter,
			buytime = leftBuy,
		}
		table.insert(arra, info)
	end       
    obj.arra = arra;
    player:SendPacketToSelf(2445,0,encode(obj));     
    return;
end

function SendSpecialRingNotice(player)
	local days = g_get_day();
	if days == activity_special_start[2] + 1 then
		player:SendPacketToSelf(2907,0,"");
	end
end

function OnUpdateDaily(player,day)
	local now_time = os.time();
	if player:get_param(378) < now_time then
		player:set_param(378,getnextweek());
		if player:get_param(377) > 3600*70 then
			player:set_param(376,3600*70);
		else
			player:set_param(376,player:get_param(377));
		end
		player:set_param(377,0);
	end
	if player:get_param(379) < now_time then
		player:set_param(379,getnextmonth());
		player:set_param(411,0);
		player:set_param(344,0); --当月累计签到奖励
	end
	
    player:set_param(200,0);	--日常任务次数
    player:set_param(210,0);	--活力卷轴限制
    player:set_param(218,0);	--玄神宫BOSS击杀数量
    player:set_param(219,0);    --迷宫神秘商店刷新标志
    player:set_param(221,0);    --玩家每日充值金额
    player:set_param(225,0);	--黄钻每日礼包领取标志
    player:set_param(237,0);	--蓝钻每日礼包领取标志
    player:set_param(253,0);	--大厅每日礼包领取标志
    if player:get_param(239) == 2 then
        player:set_param(239,0);	--Q点换购
    end
    player:set_param(242,0);	--空间每日礼包领取标志
    player:set_param(244,0);	--公会日常任务完成次数
    player:set_param(226,0);	--迷宫5层奖励
    player:set_param(227,0);	--迷宫10层奖励
    player:set_param(228,0);	--公会商店刷新时间
    player:set_param(261,0);	--跨服公会战膜拜次数
    player:set_param(278,1);    --BOSS副本每日次数
    player:set_param(279,1);    --封神台每日次数
    player:set_param(280,1);    --英雄祭坛每日次数
    player:set_param(281,1);    --水晶盗贼每日次数
    player:set_param(468,20);    --荣誉碎片(大)每日次数
    player:set_param(469,6);    --汉堡每日次数

    player:set_param(287,2);    --押镖次数次数
    player:set_param(296,3);    --天劫牢次数
    player:set_param(299,30); --魂珠小最大每日上限
    player:set_param(310,2);    --黄金矿工次数
    player:set_param(317,2);    --副本讨伐次数
    player:set_param(334,0);     --转生等级成功次数
    player:set_param(317,2);    --副本讨伐次数
    player:set_param(340,0);	--VIP领取标志
    player:set_param(341,0);	--免费原地复活次数
    player:set_param(601,0);     --每日爬塔的层数
    player:set_param(602,0);     --每日爬塔扫荡标记
    player:set_param(345,0);
    player:set_param(350,0);     --谁与争锋奖励类型
    if player:get_param(351) > 3 then
        player:set_param(352,0);     --翅膀祝福值
    end
    player:set_param(355,0);		--材料副本1每日进入次数
    player:set_task_param(355,0,0);	--材料副本1购买次数
    player:set_param(356,0);		--材料副本2每日进入次数
    player:set_task_param(356,0,0);
    player:set_param(357,0);		--材料副本3每日进入次数
    player:set_task_param(357,0,0);
    player:set_param(358,0);		--材料副本4每日进入次数
    player:set_task_param(358,0,0);
    player:set_param(375,0);    	--材料副本5每日进入次数
    player:set_task_param(375,0,0);
    player:set_param(675, 0)		--材料副本6每日进入次数
    player:set_task_param(675,0,0);
    player:set_param(674, 0)		--材料副本7每日进入次数
    player:set_task_param(674,0,0);
    
    player:set_param(213, 0)		--跨服夺宝杀怪数量
	player:set_param_misc(213, 0)	--跨服夺宝杀怪任务档次
	player:set_param(214, 0)		--跨服夺宝采集数量
	player:set_param_misc(214, 0)	--跨服夺宝采集任务档次
    
    player:set_param(360,0);    --个人副本每日进入次数
    player:set_param(361,0);    --个人副本每日进入次数
    player:set_param(362,0);    --个人副本每日进入次数
    player:set_param(363,0);    --个人副本每日进入次数
    player:set_param(364,0);    --个人副本每日进入次数
    player:set_param(365,0);    --个人副本每日进入次数
    player:set_param(229,0);    --个人副本每日进入次数
    
    player:set_param(381,0);	--清空迷宫次数
    player:set_param(382,0);	--迷宫神秘商店入口地图ID
    player:set_param(387,0);	--迷宫神秘怪物入口地图ID
    player:set_param(383,0);	--迷宫排名已计算标识
    player:set_param(384,0);	--迷宫奖励标志
    player:set_param(414,0); --清除在线
    player:set_param(413,0); --清除在线
    player:set_param(412,0); --清除签到
    player:set_param(415,0); --清除活跃
    player:set_param(416,0); --清除活跃
    player:set_param(272,0); --清除体力领取
    player:set_param(438,0);	--金砖使用次数限制
    player:set_param(439,0);	--经验盒子使用次数限制
    player:set_param(443,0);
    player:set_param(446,0);
    player:set_param(776,0);--轮回降级次数
    player:set_param(777,0);--转生降级次数
    player:set_param(779,0);--八大禁地免费进入次数
    player:set_param(780,0);--每日焚天修炼值
    player:set_param(781,0);--每日焚天修炼箱子1
    player:set_param(782,0);--每日焚天修炼箱子2
    player:set_param(783,0);--每日焚天修炼箱子3
    player:set_param(798,0);
    player:set_param(814,0);
    player:set_param(845,0);  
    
    local param, num = player:get_param_all_info(451);
    if num == 0 then
    	 player:set_param(451,0); --礼券兑换道具1
    end
    param, num = player:get_param_all_info(452);
    if num == 0 then
    	 player:set_param(452,0); --礼券兑换道具2
    end
    param, num = player:get_param_all_info(453);
    if num == 0 then
    	 player:set_param(453,0); --礼券兑换道具3
    end
    param, num = player:get_param_all_info(454);
    if num == 0 then
    	 player:set_param(454,0); --礼券兑换道具4
    end
    param, num = player:get_param_all_info(455);
    if num == 0 then
    	 player:set_param(455,0); --礼券兑换道具5
    end
    param, num = player:get_param_all_info(456);
    if num == 0 then
    	 player:set_param(456,0); --礼券兑换道具6
    end
    param, num = player:get_param_all_info(457);
    if num == 0 then
    	 player:set_param(457,0); --礼券兑换道具7
    end
    param, num = player:get_param_all_info(458);
    if num == 0 then
    	 player:set_param(458,0); --礼券兑换道具8
    end
    
    local ret = CheckChargeBackGoldTime();
    HandlerGetFanTianGifState(player);
    MailReturnPlanAward(player)
    if ret == false then
        player:set_param(444,0);
        player:set_param(445,0);
    end
    if player:get_param(470) == 2 then
        player:set_param(471,1); --清除每日充值
    else
        player:set_param(471,0); --清除每日充值
    end
    player:set_task_param(470,1,0);
    
    player:set_param(474,0);	--末日令牌炼制次数
    player:set_param(610,0);	--魂珠小次数
    player:set_param(611,0);    --魂珠中次数
    player:set_param(612,0);    --宝石小次数
    player:set_param(613,0);    --宝石中次数
    player:set_param(614,0);    --宝石大次数
    player:set_param(615,0);    --宝石巨次数
    player:set_param(616,0);    --魂珠大次数
    player:set_param(617,0);    --魂珠超大次数
    player:set_param(618,0);    --魂珠巨次数
    player:set_param(619,0);    --高级转生丹次数
    player:set_param(620,0);    --超级转生丹次数
    player:set_param(621,0);    --修炼丹小次数
    player:set_param(622,0);    --修炼丹中次数
    player:set_param(623,0);    --BOSS积分精髓
    player:set_param(624,0);    --
    player:set_param(625,0);    --小特效碎片使用次数
    player:set_param(626,0);    --中特戒碎片使用次数
    player:set_param(627,0);    --高级轮回丹使用次数
    player:set_param(628,0);    --超级轮回丹使用次数
    player:set_param(629,0);    --神级轮回丹使用次数
    player:set_param(630,0);    --预留
    player:set_param(644,0) 	--清除封测活动在线领取标志
    player:set_param(651,0)		--清楚玩家每日发送红包累计次数
    player:set_param(656,0)
    player:set_param(657,0)
    player:set_param(663,0)
    player:set_param(677, 0)
    player:set_param(676, 0)
    player:set_param(681, 0)
    player:set_param(682, 0)	
    player:set_param(683, 0)	
    player:set_param(684, 0)	
    player:set_param(685, 0)
    local start, over = GetActivityStartAndOverTimeStamp(G_Login_Present_Config);
    local cur = os.time()
    if start <= cur and cur < over then
        player:set_param(694, player:get_param(694)+1);
    end
    
    local conf, startTime, endTime = GetOperActivityConfig(G_Festival_Login)
	if conf ~= nil then 
		local flag_festival = IsResetActivityAwardFlagInfo(player, conf, 758, 835, conf and conf.overtimeStamp)
		if flag_festival == true then
			player:set_param_action(758, 1)
			player:set_param_misc(758, 0)
			player:set_param_type(758, conf.version)
		else
			local action, misc, type_ = player:get_param_all_info(758)
			player:set_param_action(758, action + 1)
		end
	end
	

    
    -- for i = 1,#G_Investment_Config do
    -- 	start, over = GetActivityStartAndOverTimeStamp(G_Investment_Config[i]);
    -- end
    -- if start < cur and cur < over then
    -- 	player:set_param(694, player:get_param(694)+1);
    -- end
   	player:ActivetyTitleDayCheck();
    
    player:SendPacketToSelf(2450,0,"");			--跨天提示
    OnGetFuBenNum(player,0);

    local value = player:get_param(642) + 1
    player:set_param(642, value)
    AcrossDayNotifyCloseBetaAct(player)
    SetSpecialItemTimes(player);
    OnSendActivityList(player,0);
    OnChargeBackGoldInfo(player,0,0);
    ReqCanShowSealMagicBoxIcon(player)
    local initTime = g_get_init_time()		
    HandleReqOpenSerActInfo(player, initTime, 1)
    NotifyInvestmentPlanHasAward(player)
    -- VcoinWheelOverNotify(player)
    SendSpecialRingNotice(player);
    OnMoneyTreeInfo(player,0)
    
    if player:GetGuildId() ~= 0 and player:get_param(244) < 5 then
        player:push_task_data(243,2);
    end
    player:set_param(689, 0)
    HandleReqPayActivityIconStatus(player)

	panel_10_0(player);  --发送充值状态
	SevenDayRewardList(player);
	OnMonthCardInfo(player);
	OnInvestmentInfo(player);
	OnLoginPresentInfo(player);
	HandlerGatherOpenActivityInfo(player);
	HandlerReqSevenDayTargetInfo(player)
	AutoCheckSevenDayTargetFinish(player)
	clearGatherGoldBoxActivityInfo(player)
end

function onEnterGame2(event,player)	--玩家每次登录游戏触发
--	if g_get_param(79) ~= g_get_union_times() then
--		NewDelAllChargeBackGoldLog()
--		g_set_param(79,g_get_union_times())
--		g_set_param(75,0)
--		g_set_param(60,0)
--		g_set_param(61,0)
--		g_set_param(62,0)
--		g_set_param(63,0)
--		g_set_param(64,0)
--	end
--	if player:get_param(813) ~= g_get_union_times() then
--		ClearActivity(player);
--		player:set_param(813,g_get_union_times());
--	end

	local now_time = os.time();
	local param_847 = player:get_param(847);
	local param_848 = player:get_param(848);
	if param_847 > 0 and now_time - param_847 < 2 then
		 player:set_param(848, param_848 + 1);
	else
		local miner_off = math.floor((now_time - player:getlastupdate()) / 60);
		if player:getlastupdate() == 0 then
			miner_off = 0;
		end
		if miner_off > 0 then
			player:setlastupdate(now_time);
			DigInfo(player,10,miner_off);
		end
		if now_time - param_847 > 300 then
			player:set_param(848, 0);
		end
	end
	player:set_param(847,now_time);
	
	if player:get_param(378) < now_time then
		if (now_time - player:get_param(378)) / (86400 * 7) > 0 then
			player:set_param(376,0);
		elseif player:get_param(377) > 3600*70 then
			player:set_param(376,3600*70);
		else
			player:set_param(376,player:get_param(377));
		end
		player:set_param(378,getnextweek());		
		player:set_param(377,0);
	end
	if player:get_param(379) < now_time then
		player:set_param(379,getnextmonth());
		player:set_param(411,0);
		player:set_param(344,0); --当月累计签到奖励
	end

	local job = player:get_job();
    local taskid = player:get_task_state(0);
    local t_state = player:get_task_state(taskid);
    if taskid == 0 then
        taskid = 1;
        player:set_task_param(1,1,0);
        player:set_task_state(1,1);
    elseif t_state > 2 and taskid < 112 then
        taskid = taskid + 1;
        player:set_task_param(taskid,1,0);
        player:set_task_state(taskid,1);
    end
    if taskid > 112 then
    	taskid = 112;
        player:set_task_state(taskid,3);
    end
    player:push_task_data(taskid,1);
    SendUpdateTrackPanel_1(player,player:get_param(207));
	
--	local param258 = player:get_param(258);
--	local param250 = player:get_param(250);
--	player:set_param(296,0);
--	player:set_param(298,0);
--	player:set_name_pre(0,"");
--	player:set_name_pre(12,"");
--	player:set_param(206,0);
	player:set_param(423,0); --膜拜城主开启标志
	player:set_param(222,0); --膜拜城主累计经验
	player:set_param(273,0);
	player:set_param(274,0);
	player:set_param(275,0);
	player:set_param(799,0);--副本标志
	
	if player:GetGuildId() ~= 0 and player:get_param(244) < 10 then
		player:push_task_data(243,2);
	end


	--发送充值界面
	panel_10_0(player)
	local ret = CheckChargeBackGoldTime();
	if ret == false then
		player:set_param(444,0);
		player:set_param(445,0);
	end

	-- --======================引导UI领取标志==============================
	obj = {};
	obj.type = player:get_param(271);
	obj.level = "10,25,50,55,65";
	player:SendPacketToSelf(2947,0,encode(obj));

	--===新手副本下线自动传送回去======
	if player:get_task_state(1) == 50 then
		player:enter_map(16,15,41,0);
		return;
	end
	if player:get_task_state(1) == 90 then
		player:enter_map(22,9,22,0);
		return;
	end
	--===BOSS积分=====================
    local now_stage = player:get_task_state(510)+1;
    local now_level = player:get_task_param(510,0);
    local now_param = now_level + now_stage * 100;   
    if now_param > 100 then
    	local mvalue = {};
    	local mtype = {};
        now_param = now_param + job * 1000;
        mvalue["1"] = hjtabe[now_param][2];
        mtype["1"] = 0;
        mvalue["2"] = hjtabe[now_param][3];
        mtype["2"] = 0;
        mvalue["5"] = hjtabe[now_param][4];
        mtype["5"] = 0;
        mvalue["6"] = hjtabe[now_param][5];
        mtype["6"] = 0;
        mvalue["9"] = hjtabe[now_param][6];
        mtype["9"] = 0;
        mvalue["10"] = hjtabe[now_param][7];
        mtype["10"] = 0;
        mvalue["3"] = hjtabe[now_param][8];
        mtype["3"] = 0;
        mvalue["4"] = hjtabe[now_param][9];
        mtype["4"] = 0;
        mvalue["7"] = hjtabe[now_param][10];
        mtype["7"] = 0;
        mvalue["8"] = hjtabe[now_param][11];
        mtype["8"] = 0;
        mvalue["0"] = hjtabe[now_param][12];
        mtype["0"] = 0;
        player:NewCumulativeUInt32Value(encode(mvalue),encode(mtype));
    end	
    NoticeBossScore(player);
    SendAwaredNotice(player);
    
    if player:get_level() > 60 and player:has_skill(170) == 0 then
		player:add_skill(170);
	end
	AutoCheckSevenDayTargetFinish(player)
end

function onRemoveWorld(event,player)
end


function onLevelUp(event,player,nOldLevel)	--玩家升级触发
	local level = player:get_level();
	local task4 = player:get_task_state(4);
	local task3 = player:get_task_state(3);
	if player:get_job() == 1 then
	    if level >= 15 and player:has_skill(7) == 0 then		--攻杀
			player:add_skill(7);
		end
		if level >= 9 and player:has_skill(12) == 0 then		--刺杀
			player:add_skill(12);
		end
		if level >= 41 and player:has_skill(80) == 0 then		--圆月
			player:add_skill(80);
		end
		if level >= 33 and player:has_skill(27) == 0 then		--冲锋
			player:add_skill(27);
		end
		if level >= 46 and player:has_skill(26) == 0 then		--烈火
			player:add_skill(26);
		end
	end
	if player:get_job() == 2 then
        if level >= 9 and player:has_skill(1) == 0 then		--火球术
			player:add_skill(1);
		end	
		if level >= 15 and player:has_skill(11) == 0 then		--法神雷电
			player:add_skill(11);
		end
		if level >= 28 and player:has_skill(8) == 0 then		--法神抗拒
			player:add_skill(8);
		end
		if level >= 23 and player:has_skill(22) == 0 then		--法神火墙
			player:add_skill(22);
		end
		if level >= 41 and player:has_skill(24) == 0 then		--幻魔雷光
			player:add_skill(24);
		end
		if level >= 46 and player:has_skill(33) == 0 then		--幻魔冰咆哮
			player:add_skill(33);
		end
		if level >= 33 and player:has_skill(31) == 0 then		--幻魔护盾
			player:add_skill(31);
		end
	end
	if player:get_job() == 3 then
		if level >= 23 and player:has_skill(18) == 0 then		--单体隐身
			player:add_skill(18);
		end
	    if level >= 23 and player:has_skill(2) == 0 then		--治疗术
			player:add_skill(2);
		end
		if level >= 52 and player:has_skill(29) == 0 then		--群体治疗术
			player:add_skill(29);
		end
		if level >= 9 and player:has_skill(13) == 0 then		--道神火符
			player:add_skill(13);
		end
		if level >= 15 and player:has_skill(6) == 0 then		--道神施毒术
			player:add_skill(6);
		end
		if level >= 41 and player:has_skill(30) == 0 then		--天玄驭兽
			player:add_skill(30);
		end
		if level >= 38 and player:has_skill(95) == 0 then		--道神防御术
			player:add_skill(95);
		end
		if level >= 46 and player:has_skill(19) == 0 then		--天玄灵隐术
			player:add_skill(19);
		end
		if level >= 33 and player:has_skill(153) == 0 then		--群体施毒术
			player:add_skill(153);
		end
	end 

	if level >= 61 and player:get_task_state(113) == 0  then
    	player:set_task_state(113,1);
    	SendUpdateTrackPanel_1(player,113);
    end	

    if level >= 70 and player:get_task_state(106) == 1  then
    	player:set_task_state(106,2);
    	player:push_task_data(106,1);
    end	

	if level >= 80 then
		if player:get_param(406) == 0 then
			local nid = math.random(1,2);
			if nid == 1 then
				player:set_param(406,1);
			else
				player:set_param(406,2);
			end
			local obj = {};
			obj.fairy_magic = player:get_param(406);
			player:SendPacketToSelf(1401,0,encode(obj));
		end
	end
	if task4 == 50 then
		if level >= 85 then
			player:set_task_state(4,55);
			player:push_task_data(1,1);
			return;
		else
			player:push_task_data(1,1);
		end
	end

	if task4 == 30 then
		if level >= 80 then
			player:set_task_state(4,35);
			player:push_task_data(1,1);
			return;
		else
			player:push_task_data(1,1);
		end
	end

	if task3 == 210 then
		if level >= 75 then
			player:set_task_state(3,215);
			player:set_task_state(4,1);
			player:push_task_data(1,1);
			return;
		else
			player:push_task_data(1,1);
		end
	end

	if task3 == 181 then
		if level >= 70 then
			player:set_task_state(3,182);
			player:push_task_data(1,1);
			player:openpanel(27);
			if player:GetMapId() == 17 then
				player:find_road_goto(17,131,146,1717);
			else
				player:openpanel(57);
			end
			return;
		else
			player:push_task_data(1,1);
		end
	end
	if task3 == 116 then
		if level >= 66 then
			player:set_task_state(3,118);
			player:push_task_data(1,1);
			player:openpanel(27);
			player:openpanel(57);
		else
			player:push_task_data(1,1);
		end
	end

	if task3 == 86 then
		if level >= 62 then
			player:set_task_state(3,87);
			player:push_task_data(1,1);
			player:openpanel(27);
			if player:GetMapId() == 12 then
				player:find_road_goto(12,95,82,1214);
				player:gui_high_focus(1,3,30,35,"点击npc寻路");
			else
				player:openpanel(57);
			end
			if player:get_task_state(10) == 0 then
				player:set_task_state(10,1);
				player:push_task_data(10,1);
				player:set_param(467,1);
			end
			return;
		else
			player:push_task_data(1,1);
		end
	end

	if task3 == 11 then
		if level >= 56 then
			player:set_task_state(3,15);
			player:push_task_data(1,1);
			player:openpanel(27);
			if player:GetMapId() == 17 then
				player:find_road_goto(17,131,160,1716);
				player:gui_high_focus(1,3,30,35,"点击npc寻路");
			else
				player:openpanel(57);
			end
			return;
		else
			player:push_task_data(1,1);
		end
	end
	
	--if nOldLevel < 64 and level >= 64 then
	--	player:SendSystemMail("祝贺你升到64级","祝贺你升级到了<font color='#FF0000'>64</font>级。"
	--		.."请再接再厉，努力升级，开启更多的系统和活动。","[10194,2,10201,2,20167,1]","[0,0,0,0]",1);
	--end
	
--if nOldLevel < 50 and level >= 50 then
	--	player:SendSystemMail("感谢参加本次封测","    本次开放的内容是首个对外测试的游戏版本，主要目的为验证游戏的基本性能与稳定，并不代表游戏的最终品质，我们仍将持续的研发和完善。<br>    欢迎大家提出各种宝贵的意见和建议，感谢各位玩家能以包容的态度对待测试过程中出现的问题。我们已经在游戏中开通了反馈平台，大家发现的问题，和对产品的意见可以通过“意见反馈”提给我们。"
		--	.."<br><br>新焚天之怒玩家粉丝群 <font color='#0BE140'>581108202</font>".."<br>封测时间：<font color='#0BE140'>2016年8月3日10:00~8月10日23:59</font>","[10224,1,0,0,0,0]","[0,0,0,0]",1);
	--end


	if nOldLevel < 60 and level >= 60 then
		SendAwaredNotice(player);
	end

	
	if nOldLevel < 70 and level >= 70 then
		player:SendSystemMail("恭喜达到70级开启转生","    1、<font color='#0be140'>转生开启</font>，您可以在<font color='#0be140'>【人物-转生】</font>界面通过快捷购买直接使用<font color='#0be140'>元宝购买转生丹</font>，或到<font color='#0be140'>神威狱</font>击杀小怪获取转生修为丹，提升转生等级；<br>    2、<font color='#0be140'>转生后实力大幅提升，并可穿戴更高等级的转生装备</font>；<br>" .. 
		"    3、安全区<font color='#0be140'>转生使者</font>将为您开启新的转生秘境；<br>    4、关注<font color='#0be140'>开服活动</font>和<font color='#0be140'>疯狂豪礼</font>，有小妮送上的超值惊喜哦~<br>                   新焚天之怒策划 小妮"	,"[0,0,0,0,0,0]","[0,0,0,0]",1);
	end
end

function OnMazeDoor(player,mapid,type)
	--player:alert(2,0,0,"神秘1层:"..player:get_param(382));
	--player:alert(2,0,0,"神秘2层:"..player:get_param(387));
	--player:alert(2,0,0,"当前地图:"..mapid);
	--player:alert(2,0,0,"门:"..type);
	local xx = 21;
	local yy = 34;
	local beginmapid = 295;
	local endmapid = 309;
	if mapid >= beginmapid and mapid < endmapid then
		if type == 1 then
			local mazedoor = g_mazedoor[1];
			if mazedoor == nil then
				return 0;
			end
			local rand = math.random(0,99);
			for i=1,#mazedoor do
				if rand < mazedoor[i][1] then
					mapid = mapid + mazedoor[i][2];
					if mapid > endmapid then
						mapid = endmapid;
					end
					break;
				end
			end
			if mapid == endmapid then
				player:alert(10,0,0,"恭喜完成极限挑战，赶紧点击NPC统计名次吧！");
			else
				player:alert(10,0,0,"选择正确，继续加油！");
			end
			local floor = g_get_param(4);		
			if mapid >= 299 and bitget(floor,1) == 0 then
				g_set_param(4,bitset(floor,1));
				g_broadcast(12,0,0,"玩家<font color='#00ccff'>"..player:GetName().."</font>一马当先，率先突破极限挑战第<font color='#ff0000'>5</font>层，大家加油吧！");
			elseif mapid >= 304 and bitget(floor,2) == 0 then
				g_set_param(4,bitset(floor,2));
				g_broadcast(12,0,0,"玩家<font color='#00ccff'>"..player:GetName().."</font>一马当先，率先突破极限挑战第<font color='#ff0000'>10</font>层，大家加油吧！");
	--		elseif mapid >= 309 and bitget(floor,3) == 0 then
	--			g_broadcast(12,0,0,"玩家<font color='#00ccff'>"..player:GetName().."</font>一马当先，率先突破极限挑战第<font color='#ff0000'>15</font>层，大家加油吧！");
	--			g_set_param(4,bitset(floor,3));
			end
		else
	--		local param382 = player:get_param(382);
	--		if mapid == param382 then
	--			g_broadcast(12,0,0,"玩家 <font color='#00ccff'>"..player:GetName().."</font> 人品爆发，进入极限挑战神秘空间，这就是命啊!");
	--			player:enter_map(315,xx,yy,0);
	--			return 315;
	--		end
			local param387 = player:get_param(387);
			if mapid == param387 then
				g_broadcast(12,0,0,"玩家 <font color='#00ccff'>"..player:GetName().."</font> 人品爆发，进入极限挑战神秘空间，这就是命啊!");
				player:enter_map(316,xx,yy,0);
				return 316;
			end
			local mazedoor = g_mazedoor[2];
			if mazedoor == nil then
				return 0;
			end
			if mapid == beginmapid then
				player:alert(10,0,0,"第一层你都能走错，你是多倒霉？！");
			else
				player:alert(10,0,0,"哎呀呀，选错了，下次注意……");
			end
			local rand = math.random(0,99);
			for i=1,#mazedoor do
				if rand < mazedoor[i][1] then
					mapid = mapid - mazedoor[i][2];
					if mapid < beginmapid then
						mapid = beginmapid;
					end
					break;
				end
			end
		end
		player:enter_map(mapid,xx,yy,0);
		return mapid;
	end
	if mapid == 315 then	--神秘1
		local param382 = player:get_param(382);
		player:enter_map(param382,xx,yy,0);
		player:set_param(382,0);
		return param382;
	end
	if mapid == 316 then	--神秘2
		local param387 = player:get_param(387);
		player:enter_map(param387,xx,yy,0);
		player:set_param(387,0);
		return param387;
	end
end

function OnRequestTran(player,mapid,mapx,mapy,type) --传送调用
    local t = tonumber(os.date("%H%M",os.time())); 
	--================ 迷宫活动 ==================================================
	if mapid == 295 then	--迷宫开始地图
		if player:get_param(381) == 1 then
			player:alert(10,0,0,"你今天已经参与过极限挑战了!");
			return;
		end
		local nMG = #activity_migong;
        for i=1,nMG do
        	if t >= activity_migong[i][3] and t < activity_migong[i][4] then
            	if player:enter_map(mapid,mapx,mapy,0) == 0 then
            		player:set_param(381,1);
            		player:set_param(383,0);
            		local rand = math.random(0,13);
            	--	player:set_param(382,295 + rand);
            		player:FinishFeats(20, 1);
            		if 2*rand > 14 then
            			rand = 2*rand - 14;
            		else
            			rand = 14 - 2*rand;
            		end
            		player:set_param(387,295 + rand);
            		
            		player:SendActivityDetail(9,3,0);	--2901
                	return;
                end
            end       
        end  
        player:alert(10,0,0,"当前不在活动期间，少年请稍安勿躁!");
        return;
	end
	--====================================================================================
	
	if mapid == 440 then	--穷奇洞窟
		local taskid = player:get_task_state(15);
		if taskid == 1 then
			player:enter_map(mapid,mapx,mapy,0);
			return;
		end
		player:alert(10,0,0,"您没有相应任务，无法进入!");
		return;
	end
	
	if mapid == 277 then	--妖王洞窟
		local taskid = player:get_task_state(34);
		if taskid == 1 then
			player:enter_map(mapid,mapx,mapy,0);
			return;
		end
		player:alert(10,0,0,"您没有相应任务，无法进入!");
		return;
	end
	
	if mapid == 280 then	--兽王巢穴
		local taskid = player:get_task_state(48);
		if taskid == 1 then
			player:enter_map(mapid,mapx,mapy,0);
			return;
		end
		player:alert(10,0,0,"您没有相应任务，无法进入!");
		return;
	end
	
	if mapid == 438 then	--奔跑地图
		local taskid = player:get_task_state(115);
		if taskid == 1 then
			player:enter_map(mapid,mapx,mapy,0);
			return;
		end
		player:alert(10,0,0,"您没有相应任务，无法进入!");
		return;
	end
	
	if mapid == 439 then	--泡点地图
		local taskid = player:get_task_state(113);
		if taskid == 1 then
			player:enter_map(mapid,mapx,mapy,0);
			return;
		end
		player:alert(10,0,0,"您没有相应任务，无法进入!");
		return;
	end
	
	if mapid == 473 then	--特戒活动地图
		local specialring = #activity_special_ring;
        for i=1,specialring do
           if t >= activity_special_ring[i][1] and t < activity_special_ring[i][2] then
               local mapx, mapy = g_RandomMapVaildPoint(mapid);
               player:enter_map(mapid,mapx,mapy,0);  
               return;
           end       
        end  
        	player:alert(10,0,0,"特戒活动还没有开启，无法进入!");
        return;
	end
	
	if mapid >= 281 and mapid <=  292 then
		local nvip = player:get_player_type();
		if nvip >= 1 then
			player:enter_map(281 + nvip - 1,mapx,mapy,0);
			return;
		end
		player:alert(10,0,0,"您不是VIP，无法进入!");
		return;
	end
	
	if mapid == 238 then
        local nQxzb = #activity_qxzb_tm;
        for i=1,nQxzb do
           if t >= activity_qxzb_tm[i][1] and t < activity_qxzb_tm[i][2] then
               if player:enter_map(mapid,mapx,mapy,0) == 0 then
               	   player:FinishFeats(7, 1);
               end
               return
            end       
        end  
        	player:alert(10,0,0,"群雄争霸活动还没有开启，无法进入!");
        return;
	end
		
    if mapid == 3 then  	
        for i = 1,#activity_pk do
            if t >= activity_pk[i][1] and t < activity_pk[i][2] then
                if player:enter_map(mapid,mapx,mapy,0) == 0 then
                	player:FinishFeats(3, 1);
                end
                return
            end
        end
        player:alert(10,0,0,"pk泡点活动还没有开启，无法进入!");
        return;
    end
    
    if mapid == 4 then
        for i = 1,#activity_wk do
            if t >= activity_wk[i][1] and t < activity_wk[i][3] then
                if player:enter_map(mapid,mapx,mapy,0) == 0 then
                	player:FinishFeats(10, 1)
                end
                return
            end
        end
        player:alert(10,0,0,"挖矿活动还没有开启，无法进入!");
        return;
    end
    
    if mapid >= 220 and mapid <= 237 then
    	local p_mapid = player:GetMapId()
    	local random = math.random(1, g_hell_config.proSum)
    	local iSum = 0;
    	local randomIndex = 0
    	local proList = g_hell_config.pro
    	for i = 1, #proList do
    		iSum = iSum + proList[i]
    		if random <= iSum then
    			randomIndex = i
    			break
    		end
    	end

    	if randomIndex == 0 then
    		randomIndex = 1  --加这个判断是为了防止策划填错概率总数
    	end

    	local randomMapid = randomIndex + 219 
    	if p_mapid == randomMapid then
    		if randomMapid == 237 then
    			random = math.random(1, 17)
    			randomMapid = randomMapid - random
    		else
    			random = math.random(1, 237 - p_mapid)
    			randomMapid = randomMapid + random
    		end
    	end

    	local iLevel = randomMapid - 219
    	local mapx, mapy = g_RandomMapVaildPoint(randomMapid)
    	if player:enter_map(randomMapid, mapx, mapy, 0) == 0 then
    		local temp_num = {"一","二","三","四","五","六","七","八","九","十","十一","十二","十三","十四","十五","十六","十七","十八"};
    		g_broadcast(12,0,0,"<font color='#00ccff'>"..player:GetName().."</font>闯入<font color='#00ccff'>第" .. temp_num[iLevel] .. "层地狱</font>，极品装备随便爆。<a href='event:M2411,1,86,99,task_track_link_npc,1,154,200,128'><u><font color='#0be140'>我要入地狱</font></u></a>");
    	end

    	return 
    end
    
    if mapid == 33 or mapid == 463 or mapid == 464 then  
       mapid = 33;      
       if g_get_day() <= 2 then
       	   local taskid = player:get_task_state(0);
			if taskid < 79 then
       	  		 mapid = 463
       	  	elseif taskid < 105 then
       	  		 mapid = 464
       	  	end
       end
    end

    if mapid == 29 then
	    for i = 1,#activity_zhengfengduomiao do
       	    if t >= activity_zhengfengduomiao[i][1] and t < activity_zhengfengduomiao[i][2] then
                if player:enter_map(mapid,mapx,mapy,0) == 0 then
                	player:FinishFeats(4, 1)
                end
                return
            end
        end
        player:alert(10,0,0,"争分夺秒将在14：30开启，请耐心等待");
        return;
    end


    if mapid == 28 then    
	   for i = 1,#activity_duobaoqibing do
       	    if t >= activity_duobaoqibing[i][1] and t < activity_duobaoqibing[i][2] then
                if player:enter_map(mapid,mapx,mapy,0) == 0 then
                	player:FinishFeats(5, 1);
                end
	       		return
	    	end
       end
       player:alert(10,0,0,"夺宝奇兵将在19：00开启，请耐心等待");   
       return;
    end 

    if mapid == 32 then    
        if t >= activity_shuiyuzhengfeng[1][1] and t < activity_shuiyuzhengfeng[1][2] then
            if player:enter_map(mapid,mapx,mapy,0) == 0 then
            	player:FinishFeats(6, 1);
            end
            return
        else 
            if t >= activity_shuiyuzhengfeng[2][1] and t < activity_shuiyuzhengfeng[2][2] then
                player:alert(10,0,0,"比赛正在进行，禁止进入!");   
                return;
            else
                player:alert(10,0,0,"谁与争锋将在12：30开始报名，请耐心等待");   
                return;
            end
         end
    end 
    
    if mapid == 270 then
	   	for i = 1,#activity_runningman do
	   		if player:get_param(343) > 0 and g_get_param(21) == player:get_param(343) then
	   			player:alert(10,0,0,"您今天已经参与过奔跑吧活动了!"); 
	   			return;
	   		end
       	    if t >= activity_runningman[i][1] and t < activity_runningman[i][2] then
                if player:enter_map(mapid,mapx,mapy,0) == 0 then
                	player:FinishFeats(9, 1);
                end
	       		return
	    	end
       end
       player:alert(10,0,0,"奔跑吧兄弟将在18：40开启，请耐心等待");   
       return;
    end  

    if mapid == 4 then
        local t3 = t % 100;
        local t4 = tonumber(os.date("%H:%M",os.time()));
        if player:num_bag_black(0) < 1 then
            player:alert(10,0,0,"背包已满，无法进入!");
        elseif player:get_level() < 60 then 
            player:alert(10,0,0,"60级开启挖矿!");
    --   elseif t % 100 < 30 then 
    --        player:alert(10,0,0,"60级开启挖矿!"..t3.."开启挖矿!");   
        end
        player:enter_map(mapid,mapx,mapy,0);
        return;
    end
    
  
    if mapid >= 34 and mapid <= 201 then 
          local now_money = player:get_vcoin();
       -- if mapid == 34 then
		--	if now_money >= 300 then
		--	    player:sub_vcoin(300);
		--	else
		--	    player:alert(10,0,0,"元宝不足，无法进入!");
		--	    return;
		--	end
      --  end
     
        local tmapid = player:GetMapId();
        local rNum = math.random(1,663);  
        if rNum < 641 then            
            mapid = math.random(34,193);  
        elseif rNum < 662 then
            mapid = math.random(194,200);  
        else
            mapid = 201;  
        end
        
        if mapid == tmapid then
            if tmapid == 201 then
                mapid = 200;
            else 
                mapid = mapid + 1;
            end     
        end
        
        mapx = mapx + math.random( -3, 3 );
        mapy = mapy + math.random( -3, 3 );  
        local eresult = player:enter_map(mapid,mapx,mapy,0);
        if eresult == 0 then
            local after_money = player:get_vcoin();
            player:WriteScriptByLog(1,tmapid, mapid, 300, after_money, now_money);
            if  mapid >= 194 then
                local nceng = mapid - 33;
                g_broadcast(15,0,0, "<font color='#00ccff'>"..player:GetName().."</font>受到上天眷顾，有幸进入"..nceng.."层，击杀BOSS可以获得大量装备与材料奖励!!"); 
            end
        end
        --player:alert(10,0,0,"<font color='#00ccff'>"..player:GetName().."</font>受到上天眷顾，有幸进入 160 层，击杀BOSS可以获得大量装备与材料奖励!!");
        --g_broadcast(15,0,0,"<font color='#00ccff'>"..player:GetName().."</font>受到上天眷顾，有幸进入 160 层，击杀BOSS可以获得大量装备与材料奖励!!"); 
        return;
     end  
    
     if mapid == 249 or mapid == 257 or mapid == 258 or mapid == 259 or (mapid <= 255 and mapid >= 250) or mapid == 437 or mapid == 260 or mapid == 474 or mapid == 261 then
         local nparam = 355;   
         if mapid == 257 or mapid == 258 or mapid == 259 then
             nparam = mapid + 99;
         elseif mapid <= 255 and mapid >= 250 then 
             nparam = mapid + 110;
         elseif mapid == 437 then 
             nparam = 375;   
         elseif mapid == 260 then
         	nparam = 675
         elseif mapid == 261 then
         	nparam = 674
         elseif mapid == 474 then
         	nparam = 229
         end
         local vparam = player:get_param(nparam);
         if g_mapentern[mapid] ~= nil and vparam >= g_mapentern[mapid][1] then
             player:alert(10,0,0,"副本次数不足，无法进入！");
             return;
         end
         
         if player:enter_map(mapid,mapx,mapy,0) == 0 then
         	if mapid < 250 or mapid > 255 and mapid ~= 474 then
         		player:set_param(nparam,vparam + 1);
         	end
	         player:FinishFeats(24, 1);
	         OnGetFuBenNum(player,0); 
	         player:updateDailyTask(2);
         end
         return;
     end
     
     if mapid == 475 then
     	local level = player:get_level()
     	if level < g_yzwc_config.minLevel then
     		player:alert(10, 0, 0, "等级不足"..g_yzwc_config.minLevel.."级,无法进入!")
     		return 
     	end
     	local tm_config = g_yzwc_config.tm
     	local willBeOver = false;
     	for i = 1, #tm_config do
     		if t >= tm_config[i][1] and t < tm_config[i][2] then
			 	local now = os.time()
		 		local next = now + 30
		 		next = tonumber(os.date("%H%M", next))
		 		if next >=  tm_config[i][2] then
		 			willBeOver = true
		 		end
			 	if willBeOver == false then
	     			local camp = g_RandomAddToCamp(player)
	     			player:set_camp(camp)
	     			if camp == 1 then
	     				local minposX = 18
	     				local maxposX = 26
	     				local minposY = 23
	     				local maxposY = 31
	     				mapx = math.random(minposX, maxposX)
	     				mapy = math.random(minposY, maxposY)
	     			elseif camp == 2 then
	     				local minposX = 44
	     				local maxposX = 52
	     				local minposY = 49
	     				local maxposY = 57
	     				mapx = math.random(minposX, maxposX)
	     				mapy = math.random(minposY, maxposY)
	     			end
	     			local guid = player:GetLowGUID()
		     		local retMsg = {
						id = guid,
						camp = camp,
					}
					player:SendPacketToSelf(4645, 0, encode(retMsg))
     			else
     				local minposX = 44
	     			local maxposX = 52
	     			local minposY = 49
	     			local maxposY = 57
	     			mapx = math.random(minposX, maxposX)
	     			mapy = math.random(minposY, maxposY)
     			end
     			player:enter_map(mapid, mapx, mapy, 0)
     			return 
     		end
     	end
     	player:alert(10, 0, 0, "夜战王城活动还没开启,无法进入!")
     	return 
     end
     
	local maphou = player:isenter_map(mapid);
	if maphou == 0 then
		--local item19083 = player:package_item(19083);
		--if player:gen_has(5100) > 0 then
		--	player:alert(21,0,0,"对不起,押镖过程中不允许传送!");
		--elseif player:get_player_type() >= 1 then
		--	player:enter_map(mapid,mapx,mapy,0);
		--elseif item19083 >= 1 then
		--	player:remove_item(19083,1,0);
        if player:enter_map(mapid,mapx,mapy,0) == 1 then
        	--player:alert(10,0,0,mapid.."号地图("..mapx..","..mapy..")坐标为不可走点");
        end
		--else
		--	player:alert(21,0,0,"对不起,您的小飞鞋不足1个无法传送");
		--end
		return;
	else
		player:alert(10,0,0,"你刚退出副本,再次进入需要"..maphou.."秒");
		return;
	end
	player:enter_map(mapid,mapx,mapy,0); 
end

function Onxiaofeixie(player)
	if player:get_player_type() >= 1 then
		return 1;
	elseif player:package_item(19083) >= 1 then
		player:remove_item(19083,1,0);
		return 1;
	else
		player:alert(21,0,0,"对不起,您的小飞鞋不足1个无法传送");
		return 0;
	end
end

function OnEquipItem(player,itemid) --return 1允许佩戴 return 0 禁止佩戴

end

function OnEquipItema(player,itemid) --佩戴装备后触发

end

function HandlerAddVipExp(player, player_type)
	local vcoin_worth = player:get_vcoin_worth();
	local viptype = player_type;
	local vipnum = player:get_player_type();
	for i=1,#g_nvip do
		if vcoin_worth >= g_nvip[i][1] and viptype < g_nvip[i][2] then
			if vipnum == 0 then
				g_set_param(3,g_get_param(3) + 1);
				g_broadcast(12,0,0,"恭喜<font color='#00ccff'>"..player:GetName().."</font>成为本服VIP会员，充值1000元宝即可成为VIP会员哦！" .."<font color='#0be140'>{_showSysWin,我也要成为VIP,OPEN_VIP}</font>");
			end
    
			player:set_vip_status(g_nvip[i][2],0,5);
			player:set_param(340,0);
			local reliveLimit = VipLimit.reliveLimit
			local vipLevel = g_nvip[i][2]
			local freeCount = reliveLimit[vipLevel + 1]
			player:set_param(341, freeCount)
			-- player:set_param(341,VipLimit[g_nvip[i][2]][2]);	--免费原地复活次数
			player:set_status(2200 + player:get_player_type(),0,100,5);
			break;
		end
	end
	ontalkvip100_0(player);
end

function OnUseVip(player,player_type,qqtype,remain_time)		--充值元宝触发
	local t = tonumber(os.date("%m%d",os.time()));
	local ndccz = remain_time;
	player:FinishFeats(22, 1);
	HandlerAddVipExp(player, player_type)
	AddRebatePayRecord(player, ndccz)
	player:set_param(221,player:get_param(221) + ndccz);
	if player:get_param(470) == 0 then
		player:set_param(470,1);
		player:set_task_param(470,1,1);
	end
	--发送充值界面
	panel_10_0(player);
	local temp_day = GetChargeMaxDay();
	if player:get_param(471) < #RechargeReward[temp_day] then
		panel_11_1(player,player:get_param(471));
	end
	
--	if qqtype == 1 then
		local double_type = g_double_charge[ndccz];
		if double_type then
			local double_flag = player:get_param(472);
			if bitget(double_flag,double_type) == 0 then
				player:SendSystemMail("首充双倍","    亲爱的玩家，恭喜您完成<font color='#0be140'>" .. ndccz .. "元宝</font>首次充值，GM赠送的<font color='#0be140'>" .. ndccz .. "绑元</font>已到帐，请注意查收<br>    完成其他档次的首充可继续领取等额绑元，<font color='#0be140'>游戏中绑元与元宝等值哦～</font><br><br>                    新焚天之怒策划 小妮"	,"[0,0,0,0,0,0]","[0,0,0,0]",1);
				player:set_param(472,bitset(double_flag,double_type));
				local obj = {};
				obj.flag = player:get_param(472);
				player:SendPacketToSelf(4436,0,encode(obj));
				player:add_vcoin_bind(ndccz);
			end
		end
--	elseif qqtype == 2 then
--		local double_type = g_double_charge[ndccz];
--		if double_type then
--			local double_flag = player:get_param(238);
--			if bitget(double_flag,double_type) == 0 then
--				player:SendSystemMail("首充双倍","    亲爱的玩家，恭喜您完成<font color='#0be140'>" .. ndccz .. "元宝</font>首次充值，GM赠送的<font color='#0be140'>" .. ndccz .. "绑元</font>已到帐，请注意查收<br>    完成其他档次的首充可继续领取等额绑元，<font color='#0be140'>游戏中绑元与元宝等值哦～</font><br><br>                    新焚天之怒策划 小妮"	,"[0,0,0,0,0,0]","[0,0,0,0]",1);
--				player:set_param(238,bitset(double_flag,double_type));
--				local obj = {};
--				obj.flag = player:get_param(238);
--				player:SendPacketToSelf(4436,0,encode(obj));
--				player:add_vcoin_bind(ndccz);
--			end
--		end
--	end
	HandlerGetFanTianGifState(player);
	SetPlayerSingleLimitPay(player, ndccz)
	HandleReqPayActivityIconStatus(player)
	HandlerReqActivityInfo(player, 63)
	HandlerGatherOpenActivityInfo(player, 63)
	local initTime = g_get_init_time()
	HandleReqOpenSerActInfo(player, initTime, 9)
	HandleReqOpenSerActInfo(player, initTime, 1)
	AddOncePayActivity(player,ndccz)
	AddNewPayRankActivityPayCount(player, ndccz)
	if (ndccz >= 100000 or player:get_vcoin_worth() >= 200000) and player:get_param(766) == 0 then
		player:set_param(766,1);
		local obj = {};
		obj.flag = 1;
		obj.effect = 1;
		player:SendPacketToSelf(4460,0,encode(obj));
	end
	NotifySevenDayPayDataChange(player)
	NotifyKeepPayDataChange(player)
	NotifyCumulativePayDataChange(player,ndccz)
	AddGoldBoxActivityParamCount(player)
	-- local vcoin_worth = player:get_vcoin_worth();
	-- local viptype = player_type;
	-- local vipnum = player:get_player_type();
	-- for i=1,#g_nvip do
	-- 	if vcoin_worth >= g_nvip[i][1] and viptype < g_nvip[i][2] then
	-- 		if vipnum == 0 then
	-- 			g_set_param(3,g_get_param(3) + 1);
	-- 			g_broadcast(12,0,0,"恭喜<font color='#00ccff'>"..player:GetName().."</font>成为本服VIP会员，充值1000元宝即可成为VIP会员哦！" .."<font color='#0be140'>{_showSysWin,我也要成为VIP,OPEN_VIP}</font>");
	-- 		end
	-- 		player:set_vip_status(g_nvip[i][2],0,5);
	-- 		player:set_param(340,0);
	-- 		player:set_param(341,VipLimit[g_nvip[i][2]][2]);	--免费原地复活次数
	-- 		player:set_status(2200 + player:get_player_type(),0,100,5);
	-- 		break;
	-- 	end
	-- end

	-- ontalkvip100_0(player);
end

function OnRepop(even,player) --移动触发
	-- local nx = player:GetX();
	-- local ny = player:GetY();
end

function OnUpdateSignAwardPan(player) --签到返回
	local obj = {};
	local arr = {};
	local mon = os.date("%d",os.time({year=os.date("%Y"),month=os.date("%m")+1,day=0}));
	obj.nowmonth = os.date("%m",os.time());
	obj.totalDays = mon;	
	obj.totalSignInDays = player:get_param(411);
	obj.isSignIn = player:get_param(412);
	obj.giftIndex = player:get_param(344);
	player:SendPacketToSelf(2414,0,encode(obj));
	SendAwaredNotice(player);
end

function OnSigninAwardPan(player,type)
	if type == 0 then
		local param = player:get_param(411);
		local mon = tonumber(os.date("%d",os.time({year=os.date("%Y"),month=os.date("%m")+1,day=0})));
		local id = param + 1;
		if id > mon then
			return 1;
		end
		local flag = player:get_param(412);
		if flag == 0 then
			local bag_num = 0;
			if g_signtabe[id][3] == 0 then
				bag_num = g_signtabe[id][3];
			else
				bag_num = 1;
			end
			if player:num_bag_black() >= bag_num then
				player:add_item(g_signtabe[id][1],g_signtabe[id][2],1,0,0);
			else
				player:alert(21,0,0,"背包空间不足，请及时清理");
				--player:SendSystemMail("签到系统","您的签到奖励","["..g_signtabe[id][1]..","..(g_signtabe[id][2]).."]","[0,0,0,0]",1);
				return 1;
			end
			player:set_param(411,id);
			player:set_param(412,1);
			player:alert(10,0,0,"成功领取奖励");
		else
			return 1;
		end
	else
		local flag = player:get_param(344);
		local param411 = player:get_param(411);
		if param411 < g_totalsigntabe[type][1] then
			return 1;
		end
		if bitget(flag,type) == 1 then
			return 1;
		end
		local t_table = g_totalsigntabe[type][2];
		if t_table ~= nil then
			local bag_num = 0;
			for i=1,#t_table do
				if t_table[i][3] == 0 then
					bag_num = bag_num + t_table[i][2];
				else
					bag_num = bag_num + 1;
				end
			end

			if player:num_bag_black() >= bag_num then
				for i=1,#t_table do
					player:add_item(t_table[i][1],t_table[i][2],1,0,0);
				end
			else
				player:alert(21,0,0,"背包空间不足，请及时清理");
				--player:SendSystemMail("签到系统","您的累计签到奖励","["..t_table[type][1]..","..(t_table[type][2]).."]","[0,0,0,0]",1);
				return 1;
			end
			local giftindex = bitset(flag,type);
			player:set_param(344,giftindex);
			player:alert(10,0,0,"成功领取奖励");
		else
			return 1;
		end
	end
	OnUpdateSignAwardPan(player);
	return 0;
end

function OnUseGameCard(player,type) --礼包触发

	if type == 0 then
		if bitget(player:get_param(361),1) == 0 then
			player:add_item(10128,1,1,0,0);
			player:set_param(361,bitset(player:get_param(361),1));
			return 1;
		else
			player:alert(10,0,0,"您已经领取过【新手卡礼包】");
			return false;
		end
	end

end


function OnPickupItem(player,itemid) --pk泡点拾取物品
	if itemid == 31501 and player:GetMapId() == 439 then
		local imagetab = {
            {7001,22,29,41105,"<font color='#ff0000'>点击查看大图</font>",1,500,99000,51007,1},
            {7002,19,31,42204,"<font color='#ff0000'>貂禅是我开的</font>",1,1500,98000,52111,2},
            {7003,26,29,43204,"<font color='#ff0000'>吊曲世姑大姐</font>",1,5000,84000,53007,3},
            {7004,27,32,41204,"<font color='#ff0000'>逗比最NB</font>",1,6000,83000,51007,4},
            {7005,22,37,41205,"<font color='#ff0000'>睾处不胜含</font>",1,10000,69000,51006,5},
            {7006,21,38,41106,"<font color='#ff0000'>孤枕思君来</font>",1,11000,6000,51005,6},
            {7007,27,28,41107,"<font color='#ff0000'>哈利波特别大</font>",1,30000,5000,51004,7},
            {7008,27,29,41107,"<font color='#ff0000'>臭皮匠</font>",1,15000,54000,51004,8},
            {7009,28,28,41107,"<font color='#ff0000'>猪哥亮</font>",1,16000,53000,51004,9},
            {7010,27,30,41107,"<font color='#ff0000'>赵日天</font>",1,20000,39000,51004,10},
            {7011,29,28,41107,"<font color='#ff0000'>瞅你咋滴</font>",1,25000,24000,51004,11}
   		};
   		
		for i=1,#imagetab do
	        local obj = {};
	        obj[1] = 439;
	        obj[2] = imagetab[i][2];
	        obj[3] = imagetab[i][3];
	        obj[4] = imagetab[i][1];
	        obj[5] = imagetab[i][4];
	        obj[6] = imagetab[i][5];
	        obj[7] = imagetab[i][6];
	        obj[9] = 1; 
	        obj[10] = imagetab[i][7];
	        obj[11] = imagetab[i][8];  
	        obj[21] = imagetab[i][9];
	        obj[22] = imagetab[i][10]; 
	        player:mon_gen(encode(obj));
	    end
	end
end


function OnSetTimer(player,index) --定时器支持最大10 计时器
	if index == 1 then
		return;
	end

	if index == 2 then
		player:enter_map(12,115,120,0);
		return;
	end

	if index == 3 then
		return;
	end

	if index == 4 then --膜拜城主
		local t = tonumber(os.date("%H%M",os.time()));
		local nLevel = player:get_level();
		local nExp = 0;
		for i = 1,#activity_mobaichengzhu do
			if t >= activity_mobaichengzhu[i][1] and t <= activity_mobaichengzhu[i][2] then
				if nLevel >= g_mobai_exp[#g_mobai_exp][1] then
					if player:get_param(423) == 1 then
						if player:GetMapId() == 1 and player:getMapFlag() == 1 then
							for i=1,#g_mobai_exp do
								if nLevel >= g_mobai_exp[i][1] then
									nExp = g_mobai_exp[i][2];
									break;
								end
							end

							local totalexp = player:get_param(222);
							player:set_param(222,totalexp + nExp);					
							player:add_exp(nExp,10);
							
							local time = os.date("*t",os.time());
						    local from = os.time({year = time.year, month = time.month, day = time.day, hour = time.hour, min = time.min, sec = time.sec});
						    local to = os.time({year = time.year, month = time.month, day = time.day, hour = string.sub(activity_mobaichengzhu[i][2],1,2), min = string.sub(activity_mobaichengzhu[i][2],-2), sec = 59});
							local obj = {};
							obj.exp = totalexp + nExp;
							obj.remaining = to - from;
							player:SendPacketToSelf(2915,0,encode(obj));
						end
						return;
					else
						player:set_timer(4,0);
						return;
					end
				end
			end
		end
		player:del_status(1106);
		player:set_timer(4,0);
		player:set_param(423,0);
		player:set_param(222,0);
	end

	if index == 6 then --倒计时
		return;
	end

	if index == 7 then --无用
		return;
	end

	if index == 8 then  --无用
		return;
	end

	if index == 9 then
		return;
	end
end

function onPlayerDied(n,player)
	
end

function OnPlayerRevive(player)

end

function OnHyzhufu(player,Hyplayer) --好友祝福

end

function OnGuildLj(player,sGuilName) --加入公会
	local todalnum = player:get_param(244);
	if todalnum < 10 then
		player:set_param(243,0);
		player:set_task_param(243,1,0);
		player:set_task_state(243,0);
		player:push_task_data(243,2);
	end
end

function OnMission(player) --快捷任务栏
	return 0;
end

function OnWk(player, mine_num, type) --挖矿
	local MapId = player:GetMapId();
	local Name = player:GetName();
	local nWksjc = math.random(1,100);
	--player:alert(2,0,0,"挖矿次数："..mine_num.." 配置概率："..g_wk2tabe[mine_num].." 触发概率："..nWksjc);
	if MapId == 4 and nWksjc <= g_wk2tabe[mine_num] then
	    local nAllItemCount = #g_wktabe[type];
	    local nWksja = math.random(1,10000);
	    --player:alert(2,0,0,"奖励触发："..nWksja);
        for j = 1, nAllItemCount do
            local nowCfg = g_wktabe[type][j];
         	--player:alert(2,0,0,"触发："..nowCfg[2]);
            if nWksja <= nowCfg[2] then
                new_add_item(player,nowCfg[3],nowCfg[1],nowCfg[4],nowCfg[6]);
               	player:alert(10,0,0,"挥汗如雨，挖得"..nowCfg[5].."x"..nowCfg[4]);
				if nowCfg[3] == 0 then
					if nowCfg[1] == 30608 then
						g_broadcast(15,0,0,"【疯狂挖矿】<font color='#00ccff'>"..Name.."</font>手气不错，在超级矿山挖到"..nowCfg[5]);
					end
				end
               	if nowCfg[3] ~= 0 then
               		local obj = {};
               		if nowCfg[3] == 3 then
               			obj.id = 1;
	               		obj.num = nowCfg[4];
	               	elseif nowCfg[3] == 1 then
               			obj.id = 2;
	               		obj.num = nowCfg[4];
               		elseif nowCfg[3] == 100 and nowCfg[4] >= 200 then
	               		g_broadcast(15,0,0,"<font color='#00ccff'>"..Name.."</font>受上天眷顾，挖到"..nowCfg[4].."绑元");
	               		obj.id = 3;
	               		obj.num = nowCfg[4];
	                elseif nowCfg[3] == 100 and nowCfg[4] >= 100 then
	                	g_broadcast(15,0,0,"<font color='#00ccff'>"..Name.."</font>人品爆发，挖到"..nowCfg[4].."绑元");
	                	obj.id = 3;
	               		obj.num = nowCfg[4];
	                elseif nowCfg[3] == 101 then
	                	g_broadcast(15,0,0,"<font color='#00ccff'>"..Name.."</font>人品爆发，挖到"..nowCfg[4].."元宝");
	                	obj.id = 4;
	               		obj.num = nowCfg[4];
	                end
	                player:SendPacketToSelf(1550,0,encode(obj));
                end
                return 1;
            end
		end
	end
	return 0;
end

function OnMagic(player,sKillId,level,gold)

end

function OnZuoqi(player,item1,item2,num) --马匹喂养

end

function onKillMon(player, monsterId) --全局杀怪触发
--[[
	local taskid = 77;
	local killnum = 20;
	local mapid = 33;
	local nmap = player:GetMapId();
	local task = player:get_task_state(taskid);
	if nmap == mapid and task == 1 then	
		local nownum = player:get_task_param(taskid,1);
		if nownum + 1 < killnum then
			player:set_task_param(taskid,1,nownum + 1);
		else
			player:set_task_param(taskid,1,killnum);
	        player:set_task_state(taskid,2);	  
	    end      
	    player:push_task_data(taskid,1);
	end
--]]
	KillSpecilBossNotifySevenDayTargetFinish(player, monsterId)
end

function onArenadz(player) --竞技场点赞

end

function onArena(player,rankinga,rankingb) --竞技场翻牌  0成功 1失败

end

function onGuildwy(player,string,ntype) --boss卡牌喂养 ntype==1 二次确认

end

function lua_string_split(str,split_char)  --切割
	 local sub_str_tab = {};
	 while (true) do
		local pos = string.find(str,split_char);
		if (not pos) then
			local size_t = table.getn(sub_str_tab);
			table.insert(sub_str_tab,size_t + 1,str);
			break;
		end;
		local sub_str = string.sub(str, 1, pos - 1);
		local size_t = table.getn(sub_str_tab);
		table.insert(sub_str_tab,size_t + 1,sub_str);
		local t = string.len(str);
		str = string.sub(str, pos + 1, t);
	end
	return sub_str_tab;
end

function OnCardIdentification(player,string)  --一键封魔卡鉴定

end
 --=================玉净瓶===================
function onyujingping(player,item)
end
--==================封号=====================
function onFenghao(player)
end
--==================更换城主=====================
function update_urban_master(player1,player2,ntype)
end

function fubenmon(mapid,instanceid,luaid)

end

function onwabaotishi(player,itemid) --挖宝兑换提示
	player:SendTreasureNewsMessage(2,player:GetName().." 兑换了:#&item"..itemid.."#&")
	player:SendTreasureNewsMessage(3,player:GetName().." 兑换了:#&item"..itemid.."#&")
end

local onlinetb = {10,20,30};

function OnUpdateline(player) --在线奖励返回	
	local nkqts = g_get_day();	
--	player:alert(2,0,0,"开服："..nkqts);
	if nkqts >= 1 then	
		local param413 = player:get_param(413);
		local nowtime = os.time();
		local online_time = player:get_online_time();
		local obj = {};
		local arr = {};
		for i = 1,#g_onlinetabe do
			local target = {};
			target.id = i;
			target.needtime = g_onlinetabe[i][1];
			target.hasget = bitget(param413,i);
			if online_time > g_onlinetabe[i][1] then
				target.onlinetime = nowtime + g_onlinetabe[i][1];
			else
				target.onlinetime = nowtime + (g_onlinetabe[i][1] - online_time);
			end
			table.insert(arr,target);
		end
		obj.pass = online_time;
		obj.items = arr;
		
	    local week = g_getWeek();		
--		player:alert(2,0,0,"本周："..week);
		local lastreward = math.floor(player:get_param(376) / 3600);
		local reward = math.floor(player:get_param(377) / 3600);

		if reward > 70 then
			reward = 70;
		end
		
		if week == 1 then
			obj.lastGold = 0;
			obj.nowGold = reward * onlinetb[1];
		elseif week == 2 then
			obj.lastGold = lastreward * onlinetb[1];
			obj.nowGold = reward * onlinetb[2];
		elseif week == 3 then
			obj.lastGold = lastreward * onlinetb[2];
			obj.nowGold = reward * onlinetb[3];
		else
			obj.lastGold = lastreward * onlinetb[3];
			obj.nowGold = reward * onlinetb[3];
		end
		player:SendPacketToSelf(2421,0,encode(obj));
		SendAwaredNotice(player);
	end
end

function OnlineAward(player,id)
	local online_time = player:get_online_time();
	local param413 = player:get_param(413);
	local flag = 0;
	if id == 1 then
		for i = 1,#g_onlinetabe do
			if g_onlinetabe[i][1] < online_time and bitget(param413,i) == 0 then
				local bag_num = 0;
				local itemnum = #g_onlinetabe[i][2];
				for num=1,itemnum do
					if g_onlinetabe[i][2][num][3] == 0 then
						bag_num = bag_num + g_onlinetabe[i][2][num][2];
					else
						bag_num = bag_num + 1;
					end
				end
				
				if player:num_bag_black() < bag_num then
					player:alert(21,0,0,"背包空间不足，请及时清理");
					return;
				end
				param413 = bitset(param413,i);
				player:set_param(413,param413);
				for j = 1,itemnum do
					player:add_item(g_onlinetabe[i][2][j][1],g_onlinetabe[i][2][j][2],1,0,0);
				end
				flag = 1;
			end
		end
	else
		local param376 = math.floor(player:get_param(376) / 3600);
		if param376 > 0 then
			local week = g_getWeek();
			if week > 1 then
				if week == 2 then
					player:add_vcoin_bind(param376 * onlinetb[1]);
				elseif week == 3 then
					player:add_vcoin_bind(param376 * onlinetb[2]);
				else
					player:add_vcoin_bind(param376 * onlinetb[3]);
				end
				player:set_param(376,0);
				flag = 1;
			end
		else
			return 1;
		end
	end
	if flag == 1 then
		OnUpdateline(player);
		player:alert(10,0,0,"成功领取奖励");
	end
	return 0;
end

function OnUpdateActive(player) --日常返回
	local Activetabe = {
	[1]={[100]="精打细算",[101]="游戏[充值]超过1元宝",[102]=10241,[103]=1,[104]=10279,[105]=1,[106]=10256,[107]=5,[108]=1,[109]=421},
	[2]={[100]="炼妖伏魔",[101]="完成[炼妖任务]5次",[102]=10064,[103]=1,[104]=19028,[105]=200,[106]=10256,[107]=2,[108]=3,[109]=415},
	[3]={[100]="副本达人",[101]="参加[任意副本]1次",[102]=10064,[103]=1,[104]=19028,[105]=200,[106]=10256,[107]=2,[108]=1,[109]=417},
	[4]={[100]="强化大师",[101]="强化[任意装备]1次",[102]=10221,[103]=1,[104]=19028,[105]=200,[106]=10256,[107]=2,[108]=1,[109]=418},
	[5]={[100]="千锤百炼",[101]="合成[任意装备]1次",[102]=10221,[103]=1,[104]=19028,[105]=200,[106]=10256,[107]=2,[108]=1,[109]=419},
	[6]={[100]="赏金猎人",[101]="击杀[任意怪物]3000只",[102]=10221,[103]=1,[104]=19028,[105]=200,[106]=10256,[107]=2,[108]=3000,[109]=420},
	[7]={[100]="挥金如土",[101]="游戏[消费]超过999元宝",[102]=10221,[103]=1,[104]=19028,[105]=500,[106]=10256,[107]=5,[108]=999,[109]=428}
	};
	local arra = {};
	local arrb = {};
	local targeta;
	local targetb;
	for i=1,7 do
		targetb = {};
		arra = {};
		targetb.id = i;

		targeta = {};
		targeta.itemid = Activetabe[i][102];
		targeta.num = Activetabe[i][103];
		table.insert(arra,targeta);

		targeta = {};
		targeta.itemid = Activetabe[i][104];
		targeta.num = Activetabe[i][105];
		table.insert(arra,targeta);

		targeta = {};
		targeta.itemid = Activetabe[i][106];
		targeta.num = Activetabe[i][107];
		table.insert(arra,targeta);

		targetb.itemids = arra;
		targetb.title = Activetabe[i][100];
		targetb.desc = Activetabe[i][101];
		targetb.hasget = bitget(player:get_param(414),i);
		targetb.current = player:get_param(Activetabe[i][109]);
		targetb.need = Activetabe[i][108];
		targetb.oper = i;
		table.insert(arrb,targetb);
	end
	player:SendPacketToSelf(2422,0,encode(arrb));
end

function OnActive(player,id)
end

function OnDailywage(player,id,count)  --系统返回
	if id == 8 then --商城购物

	end
end

function Ong_lua_excu(player,id)

end

function onkillhum(event,Killplayer,Deadplayer)
	if Deadplayer:GetMapId() == 76 then
		Deadplayer:ReviveNotice(3,5);
	end
end

function Onguildati(player)  --击杀答题

end

function Onstrengthen(player,itemid,level,armolevel,purity) --强化返回
    if level == 7 or level == 12 then
        g_broadcast(13,0,0,"<font color='#00ccff'>"..player:GetName().."</font>成功将{_equip," ..
                 itemid..","..level.."," ..armolevel .. ",0," ..  purity .."}强化到+"..level.."，实力大增！<font color='#28ff28'>{_showSysWin,我也要强化,OPEN_FORGE}</font>")
    end
    OnCompleteQest(player,3,0,0);
end

function OnGuilMon(player) --公会刷怪

end


function Onhecheng(player,name)  --合成

end

function Onshuye(player,name)  --书页合成
	if player:get_task_state(4) == 27 then
		local nLevel = player:get_level()
		if nLevel >= 80 then
			player:set_task_state(4,35);
		else
			player:set_task_state(4,30);
		end
		player:add_exp(5000000);

		player:push_task_data(4,1);
		player:gui_high_focus(1,3,30,35,"点击继续任务");
	end
end


function Ontili(player)  --体力
	local t = tonumber(os.date("%H%M",os.time()));
	local obj = {};
	arra = {};

	targeta = {};
	targeta.id = 8;
	targeta.title = "豪华午餐";
	targeta.text = "每天:12:00-14:00";
	targeta.huoli = 300;
	if t >= 1200 and t <= 1400 then
		targeta.open = 1;
	else
		targeta.open = 0;
	end
	targeta.vip = 0;
	targeta.hasget = player:get_param(272);
	table.insert(arra,targeta);

	targeta = {};
	targeta.id = 9;
	targeta.title = "豪华午餐(额外)";
	targeta.text = "VIP1可额外领取";
	targeta.huoli = 300;
	if t >= 1200 and t <= 1400 then
		targeta.open = 1;
	else
		targeta.open = 0;
	end
	targeta.vip = 1;
	targeta.hasget = player:get_param(326);
	table.insert(arra,targeta);

	targeta = {};
	targeta.id = 10;
	targeta.title = "豪华晚餐";
	targeta.text = "每天:18:00-19:00";
	targeta.huoli = 300;
	targeta.vip = 0;
	if t >= 1800 and t <= 1900 then
		targeta.open = 1;
	else
		targeta.open = 0;
	end
	targeta.hasget = player:get_param(327);
	table.insert(arra,targeta);

	targeta = {};
	targeta.id = 11;
	targeta.title = "豪华晚餐(额外)";
	targeta.text = "VIP5可额外领取";
	targeta.huoli = 300;
	if t >= 1800 and t <= 1900 then
		targeta.open = 1;
	else
		targeta.open = 0;
	end
	targeta.vip = 5;
	targeta.hasget = player:get_param(328);
	table.insert(arra,targeta);

	obj.list = arra;
	player:SendPacketToSelf(2438,0,encode(obj));
end

function NoticeBossScore(player)
	if player:get_level() < g_SysOpenSetting[1].level then
		return 
	end
	local job = player:get_job();
    local now_fen = player:get_param(510);
    local now_stage = player:get_task_state(510)+1;
    local now_level = player:get_task_param(510,0)+1;
    local now_param = now_level + now_stage * 100 + job * 1000;
    local old_param = now_param - 1;
    if now_stage >= 4 and now_level >= 12 then
    	return;
    end
    if now_level > 12 and now_stage < 4 then
        now_param = 1 + (now_stage+1) * 100 + job * 1000;
    end   
    
	if now_fen >= hjtabe[now_param][1] and now_param % 1000 <= 412 then
		local obj = {};
		obj.id = 25;
		obj.ret = 1;
		player:SendPacketToSelf(2437,0,encode(obj));
	end
	
end

function OnLevelUpBossFen(player,type)
    local job = player:get_job();
    local now_fen = player:get_param(510);
    local now_stage = player:get_task_state(510)+1;
    local now_level = player:get_task_param(510,0)+1;
    local old_stage = now_stage-1;
    local old_level = now_level-1;
    local now_param = now_level + now_stage * 100 + job * 1000;
    local old_param = now_param - 1;
    if now_level > 12 and now_stage < 4 then
        now_param = 1 + (now_stage+1) * 100 + job * 1000;
    end
    local add_min_attack_1 = 0;
    local add_max_attack_1 = 0;
    local add_min_attack_2 = 0;
    local add_max_attack_2 = 0;
    local add_min_attack_3 = 0;
    local add_max_attack_3 = 0;
    local add_min_guard = 0;
    local add_max_guard = 0;
    local add_min_spell_guard = 0;
    local add_max_seell_guard = 0;
    local add_health = 0;

   -- player:alert(2,0,0," "..now_param.."  "..now_level.."  "..now_stage);
    if now_fen >= hjtabe[now_param][1] and now_param % 1000 <= 412 then
         local after_fen = now_fen;
         if type == 0 and now_level <= 12 then
             after_fen = now_fen - hjtabe[now_param][1];
             --now_level = now_level + 1;
             player:set_task_param(510,0,now_level);
             player:set_task_state(510, now_stage-1);
             player:set_param(510,after_fen,"主动升级",0,old_stage,now_stage-1,old_level,now_level);
         elseif type == 0 and now_level > 12 and now_stage < 4 then
             after_fen = now_fen - hjtabe[now_param][1];
             now_level = 1;
             now_stage = now_stage + 1;
             player:set_task_param(510,0,now_level);
             player:set_task_state(510, now_stage-1);
             player:set_param(510,after_fen,"主动升级",0,old_stage,now_stage-1,old_level,now_level);
         elseif type == 1 then
             while now_param % 1000 <= 412 and after_fen >= hjtabe[now_param][1] do
                 after_fen = now_fen - hjtabe[now_param][1];
                 if now_level < 12 or (now_level >= 12 and now_stage == 4) then
                     now_level = now_level + 1;
                 elseif now_level >= 12 and now_stage < 4 then
                     now_level = 1;
                     now_stage = now_stage + 1;               
                 end
                 now_param = now_level + now_stage * 100 + job * 1000;
                -- player:alert(2,0,0," "..now_param.."  "..now_level.."  "..now_stage);
             end
                      
             if now_level == 1 and now_stage <= 4 then
                 now_level = 12;
                 now_stage = now_stage - 1;
             end
             
             if now_level > 12 then
                 now_level = 12;
             end
             player:set_task_param(510,0,now_level);
             player:set_task_state(510, now_stage-1);
             player:set_param(510,after_fen,"主动升级",0,old_stage,now_stage-1,old_level,now_level);
         end
		
		 if now_level == 12 then
		 	 g_broadcast(12,0,0,"恭喜<font color='#00ccff'>"..player:GetName().."</font>BOSS积分升级至<font color='#00ccff'>" ..g_boss_fen_note[now_stage].."</font>，实力大进!");
		 end		
         now_param = now_level + now_stage * 100 + job * 1000;
         --player:alert(2,0,0," "..now_param.."  "..old_param);
         local mvalue = {};
		 local mtype = {};		
         if now_param ~= old_param then
         	 add_min_attack_1 = hjtabe[now_param][2] - hjtabe[old_param][2];
             add_max_attack_1 = hjtabe[now_param][3] - hjtabe[old_param][3];
      
             mvalue["1"] = add_min_attack_1;
             mtype["1"] = 0;
             mvalue["2"] = add_max_attack_1;
             mtype["2"] = 0;
             add_min_attack_2 = hjtabe[now_param][4] - hjtabe[old_param][4];
             add_max_attack_2 = hjtabe[now_param][5] - hjtabe[old_param][5];
       
             mvalue["5"] = add_min_attack_2;
             mtype["5"] = 0;
             mvalue["6"] = add_max_attack_2;
             mtype["6"] = 0;
             add_min_attack_3 = hjtabe[now_param][6] - hjtabe[old_param][6];
             add_max_attack_3 = hjtabe[now_param][7] - hjtabe[old_param][7];
            
             mvalue["9"] = add_min_attack_3;
             mtype["9"] = 0;
             mvalue["10"] = add_max_attack_3;
             mtype["10"] = 0;
             
             add_min_guard = hjtabe[now_param][8] - hjtabe[old_param][8];
             add_max_guard = hjtabe[now_param][9] - hjtabe[old_param][9];
             add_min_spell_guard = hjtabe[now_param][10] - hjtabe[old_param][10];
             add_max_seell_guard = hjtabe[now_param][11] - hjtabe[old_param][11];
             add_health = hjtabe[now_param][12] - hjtabe[old_param][12];
             
             mvalue["3"] = add_min_guard;
             mtype["3"] = 0;
             mvalue["4"] = add_max_guard;
             mtype["4"] = 0;
             mvalue["7"] = add_min_spell_guard;
             mtype["7"] = 0;
             mvalue["8"] = add_max_seell_guard;
             mtype["8"] = 0;
             mvalue["0"] = add_health;
             mtype["0"] = 0;
         end

         player:CumulativeUInt32Value(encode(mvalue),encode(mtype));
    else
          player:alert(21,0,0,"对不起,你没有足够的boss积分");
    end
end

function OffLineRewareList(player)
	local offtime = math.floor(player:get_param(380) / 3600);
	if offtime > 72 then
		offtime = 72;
	end
	local param385 = player:get_param(385);	
	local obj = {};
	local arr = {};
	for i = 1,#g_offlinereward do
		local target = {};
		target.id = i;
		target.exp = g_offlinereward[i][1];
		target.gold = g_offlinereward[i][2];
		target.offtime = offtime;
		if offtime > 0 then
			target.flag = 0;
		elseif param385 == 0 then
			target.flag = 2;
		elseif bitget(param385,i) == 1 then
			target.flag = 1;
		else
			target.flag = 2;
		end
		table.insert(arr,target);
	end
	obj.offline = offtime;
	obj.id = id;
	obj.list = arr;
	player:SendPacketToSelf(2426,0,encode(obj));
	SendAwaredNotice(player);
end

function OnOffLineReward(player,id)
	if id > 0 then
		local offlinereward = g_offlinereward[id];
		if offlinereward == nil then
			return 1;
		end
		local offtime = math.floor(player:get_param(380) / 3600);
		if offtime < 1 then
			return 1;		
		end
		if offtime > 72 then
			offtime = 72;
		end
		local now_money = player:get_vcoin();
		if now_money < offlinereward[2]*offtime then
			player:alert(10,0,0,"元宝不足，不能领取!");
			return 1;			
		end
		player:set_param(385,bitset(0,id));
		player:sub_vcoin(offlinereward[2]*offtime);
		player:GiveXp(offlinereward[1]*offtime);
		player:set_param(380,0);		
	end
	OffLineRewareList(player);
	return 0;
end

function OnSevenDayReward(player,id)
	if id > 0 then
--		local nDay = g_get_day();				--开服天数
		local nDay = player:get_login_days();	--登录天数
		if nDay < id then
			return 1;
		end
		local sevendayreward = g_sevendayreward[id];
		if sevendayreward == nil then
			return 1;
		end
		local param422 = player:get_param(422);					
		if bitget(param422,id) == 1 then
			player:alert(21,0,0,"不能重复领取奖励！");
			return 1;
		end		
		local bag_num = 0;
		for i=1,#sevendayreward do
			if sevendayreward[i][3] == 0 then
				bag_num = bag_num + sevendayreward[i][2];
			else
				bag_num = bag_num + 1;
			end
		end
		
		if player:num_bag_black(0) < bag_num then
			player:alert(21,0,0,"背包空间不足，请及时清理");
			return 1;
		end
		player:set_param(422,bitset(param422,id));
		for i=1,#sevendayreward do
			player:add_item(sevendayreward[i][1],sevendayreward[i][2],1,0,0);
		end
		player:alert(10,0,0,"成功领取奖励");
	end
	SevenDayRewardList(player);
	return 0;
end

function OnClearTower(player)
	local start_tower = player:get_param(601);
	local end_tower = player:get_param(600);	
	local obj = {};
	local mar = {};
	for funid = start_tower+1,end_tower do
		for j = 1,#TowerDaily[funid] do
			local flag = 0;
			for i = 1,#mar do
				if mar[i].itemid == TowerDaily[funid][j][2] then
					mar[i].itemnum = mar[i].itemnum + TowerDaily[funid][j][3];
					flag = 1;
					break;
				end
			end
			if flag == 0 then
				local target = {};
				target.type = TowerDaily[funid][j][1];
				target.itemid = TowerDaily[funid][j][2];
				target.itemnum = TowerDaily[funid][j][3];
				target.bind = TowerDaily[funid][j][4];
				target.maxnum = TowerDaily[funid][j][5];
				table.insert(mar,target);
				
			end	
		end
	end
	obj.arra = mar;
	obj.ret = 0;
	local needslot = 0;
	for i = 1,#mar do
		if mar[i].type == 1 then
			needslot = needslot + math.ceil(mar[i].itemnum/mar[i].maxnum);
		end
	end
	if player:num_bag_black() < needslot then
		player:alert(10,0,0,"你的背包空位不足,无法进行扫荡");
		obj.ret = 1;
	else
		for i = 1,#mar do
			new_add_item(player,mar[i].type,mar[i].itemid,mar[i].itemnum,mar[i].bind);
		end
		player:set_param(601,end_tower);
		player:alert(10,0,0,"扫荡成功");
	end
	player:SendPacketToSelf(3610,0,encode(obj));
end

function OnTowerReward(player,towerid)
	do 
		return;
	end
	local flagnum = math.ceil(towerid/32) + 602;
	local flag = player:get_param(flagnum);
	local index = towerid%32;
	if index == 0 then
		index = 32;
	end
	if bitget(flag,index) == 1 then
		player:alert(10,0,0,"该关卡的奖励已经领取过了");
		return;
	end
	local needslot = 0;
	for i = 1,#TowerFirst[towerid] do
		if TowerFirst[towerid][i][1] == 1 then
			needslot = needslot + math.ceil(TowerFirst[towerid][i][3]/TowerFirst[towerid][i][5]);
		end
	end
	if player:num_bag_black() < needslot then
		player:alert(10,0,0,"你的背包空位不足,无法领取奖励");
		return;
	end
	local str = "领取成功,获得";
	local str_flag = 0;
	for i = 1,#TowerFirst[towerid] do
		new_add_item(player,TowerFirst[towerid][i][1],TowerFirst[towerid][i][2],TowerFirst[towerid][i][3],TowerFirst[towerid][i][4]);
		if str_flag == 0 then
			str_flag = 1;
			str = str .. QxzbText[TowerFirst[towerid][i][1]] .. " x " .. TowerFirst[towerid][i][3];
		else
			str = str ..",".. QxzbText[TowerFirst[towerid][i][1]] .. " x " .. TowerFirst[towerid][i][3];
		end
		
	end
	player:alert(10,0,0,str);
	player:set_param(flagnum,bitset(flag,index));
end

function OnOperatePanic(player,type, use)
	local param220 = player:get_param(220);
	if type == 0 then
		local obj = {};
		local tobj = {};
		for i=1,4 do
			local target = {};
			target.id = i;
			target.flag = bitget(param220,i);
			table.insert(tobj,target);
		end
		obj.items = tobj;
		player:SendPacketToSelf(4413,0,encode(obj));
	else	
		if g_panicbuy[type] == nil then
			return;
		end
		local flag = bitget(param220,type);
		if flag == 1 then
			return;
		end
		local now_money = player:get_vcoin();
		if now_money < g_panicbuy[type]["money"] then
			player:alert(10,0,0,"元宝不足");
			return;			
		end
		local job = player:GetClass();
		local gen = player:GetGender();	
		local bag_num = 0;
		local panicbuy = g_panicbuy[type][job][gen];
		for i=1,#panicbuy do
			if panicbuy[i][3] == 0 then
				bag_num = bag_num + panicbuy[i][2];
			else
				bag_num = bag_num + 1;
			end
		end		
		if player:num_bag_black() < bag_num then
			player:alert(10,0,0,"背包空间不足，请及时清理");
			return 1;
		end
		player:sub_vcoin(g_panicbuy[type]["money"]);
		player:set_param(220,bitset(param220,type));
		for i=1,#panicbuy do
			local flag = panicbuy[i][4] or 1
			player:add_item(panicbuy[i][1],panicbuy[i][2],flag,0,0);
		end
		local obj = {};
		obj.id = type;
		obj.flag = 1;
		player:SendPacketToSelf(4414,0,encode(obj));
	--	HandlerGetFanTianGifState(player);
		
		if type == 1 then
			g_broadcast(12,0,0,"<font color='#00ccff'>"..player:GetName().."</font>领取了疯狂豪礼<font color='#ff0000'>装备礼包</font>，全套高级紫装轻松拥有！" .. "<font color='#0be140'>{_showSysWin,我也要领取,OPEN_INVESTPLAN,1}</font>");
		elseif type == 2 then
			g_broadcast(12,0,0,"<font color='#00ccff'>"..player:GetName().."</font>领取了疯狂豪礼<font color='#ff0000'>神翼礼包</font>，超值翅膀升级材料收入囊中！" .. "<font color='#0be140'>{_showSysWin,我也要领取,OPEN_INVESTPLAN,1}</font>");
		elseif type == 3 then
			g_broadcast(12,0,0,"<font color='#00ccff'>"..player:GetName().."</font>领取了疯狂豪礼<font color='#ff0000'>转生礼包</font>，转生等级直达三阶！" .. "<font color='#0be140'>{_showSysWin,我也要领取,OPEN_INVESTPLAN,1}</font>");
		elseif type == 4 then
			g_broadcast(12,0,0,"<font color='#00ccff'>"..player:GetName().."</font>领取了疯狂豪礼<font color='#ff0000'>特戒礼包</font>，珍贵特戒材料低价收入囊中！" .. "<font color='#0be140'>{_showSysWin,我也要领取,OPEN_INVESTPLAN,1}</font>");
		end 
		
		if (type == 3 or type == 4) and use == 1 then
			player:UseItemByID(panicbuy[1][1], panicbuy[1][2])
		end
	end
end

function GetLevelReward(player,type)
	if player:num_bag_black() < 1 then
		player:alert(10,0,0,"背包空间不足，请及时清理");
		return;
	end
	local param386 = player:get_param(386);
	type = type + 1;
	if type > #LevelReward then
		return;
	end
	if player:GetLevel() < LevelReward[type][1] then
		return;
	end
	if bitget(param386,type) == 1 then
		player:alert(10,0,0,"该奖励已经领取过了");
		return;
	end
	local index = (player:get_gender()-1)*3 + player:get_job() + 1;
	player:add_item( LevelReward[type][index],1,1,0,0);
	player:set_param(386,bitset(param386,type));
end

function OnQQZoneReward(player,type,id)
	if type == 1 then
		if player:get_param(223) == 1 then
			return;
		end
		local bag_num = 0;
		local qqzone = g_QQZoneReward[type];
		if qqzone == nil then
			return;
		end
		for i=1,#qqzone do
			if qqzone[i][3] == 0 then
				bag_num = bag_num + qqzone[i][2];
			else
				bag_num = bag_num + 1;
			end
		end		
		if player:num_bag_black() < bag_num then
			player:alert(10,0,0,"背包空间不足，请及时清理");
			return;
		end
		player:set_param(223,1);
		for i=1,#qqzone do
			player:add_item(qqzone[i][1],qqzone[i][2],1,0,0,1);
		end
	elseif type == 2 then
		local param = player:get_param(224);
		if bitget(param,id) == 1 then
			return;
		end			
		if g_QQZoneReward[type][id] == nil then
			return;
		end
		local level = player:GetLevel();
		if level < g_QQZoneReward[type][id][1] then
			player:alert(10,0,0,"等级不足，不能领取礼包");
			return;
		end
		local bag_num = 0;
		local qqzone = g_QQZoneReward[type][id][2];
		for i=1,#qqzone do
			if qqzone[i][3] == 0 then
				bag_num = bag_num + qqzone[i][2];
			else
				bag_num = bag_num + 1;
			end
		end		
		if player:num_bag_black() < bag_num then
			player:alert(10,0,0,"背包空间不足，请及时清理");
			return;
		end
		player:set_param(224,bitset(param,id));
		for i=1,#qqzone do
			player:add_item(qqzone[i][1],qqzone[i][2],1,0,0,1);
		end
	elseif type == 3 then
		local param = player:get_param(225);
		local index = 1;
		if id == 10 then
			index = 2;
		end
		if bitget(param,index) == 1 then
			return;
		end
		local bag_num = 0;
		local qqzone = g_QQZoneReward[type][id];
		if qqzone == nil then
			return;
		end
		for i=1,#qqzone do
			if qqzone[i][3] == 0 then
				bag_num = bag_num + qqzone[i][2];
			else
				bag_num = bag_num + 1;
			end
		end		
		if player:num_bag_black() < bag_num then
			player:alert(10,0,0,"背包空间不足，请及时清理");
			return;
		end
		player:set_param(225,bitset(param,index));
		for i=1,#qqzone do
			player:add_item(qqzone[i][1],qqzone[i][2],1,0,0,1);
		end
	end
end

function OnQQBlueReward(player,type,id)
	if type == 1 then
		if player:get_param(235) == 1 then
			return;
		end
		local bag_num = 0;
		local qqblue = g_QQBlueReward[type];
		if qqblue == nil then
			return;
		end
		for i=1,#qqblue do
			if qqblue[i][3] == 0 then
				bag_num = bag_num + qqblue[i][2];
			else
				bag_num = bag_num + 1;
			end
		end		
		if player:num_bag_black() < bag_num then
			player:alert(10,0,0,"背包空间不足，请及时清理");
			return;
		end
		player:set_param(235,1);
		for i=1,#qqblue do
			player:add_item(qqblue[i][1],qqblue[i][2],1,0,0,1);
		end
	elseif type == 2 then
		local param = player:get_param(236);
		if bitget(param,id) == 1 then
			return;
		end			
		if g_QQBlueReward[type][id] == nil then
			return;
		end
		local level = player:GetLevel();
		if level < g_QQBlueReward[type][id][1] then
			player:alert(10,0,0,"等级不足，不能领取礼包");
			return;
		end
		local bag_num = 0;
		local qqblue = g_QQBlueReward[type][id][2];
		for i=1,#qqblue do
			if qqblue[i][3] == 0 then
				bag_num = bag_num + qqblue[i][2];
			else
				bag_num = bag_num + 1;
			end
		end		
		if player:num_bag_black() < bag_num then
			player:alert(10,0,0,"背包空间不足，请及时清理");
			return;
		end
		player:set_param(236,bitset(param,id));
		for i=1,#qqblue do
			player:add_item(qqblue[i][1],qqblue[i][2],1,0,0,1);
		end
	elseif type == 3 then
		local param = player:get_param(237);
		local index = 1;
		if id == 10 then
			index = 2;
		elseif id == 11 then
			index = 3;
		end
		if bitget(param,index) == 1 then
			return;
		end
		local bag_num = 0;
		local qqblue = g_QQBlueReward[type][id];
		if qqblue == nil then
			return;
		end
		for i=1,#qqblue do
			if qqblue[i][3] == 0 then
				bag_num = bag_num + qqblue[i][2];
			else
				bag_num = bag_num + 1;
			end
		end		
		if player:num_bag_black() < bag_num then
			player:alert(10,0,0,"背包空间不足，请及时清理");
			return;
		end
		player:set_param(237,bitset(param,index));
		for i=1,#qqblue do
			player:add_item(qqblue[i][1],qqblue[i][2],1,0,0,1);
		end
	end
end

function OnMonthCardInfo(player,id)
	local obj = {};
	obj.type  = player:get_param(440);
	obj.time = player:get_param(442);	
	obj.reward_flag  = player:get_param(443);
--	obj.month_flag = player:get_param(446);
	local now = os.time();
--	player:set_name_pre(15,"");
--	player:set_name_pre(16,"");
	if now >= obj.time then
		obj.effect = 0;
	else
		obj.effect = 1;
--		if obj.type == 1 then
--			player:set_name_pre(15,"1123");
--		else
--			player:set_name_pre(16,"1124");
--		end
	end
	player:SendPacketToSelf(4080,0,encode(obj));
end

function OnBuyMonthCard(player,type,id)
	if type == 0 then
		return;
	end
	if type > #g_month_card_info then
		return;
	end
	local mytype = player:get_param(440);
	local mytime = player:get_param(442);
	local now = os.time();
	if mytime >= now and type <= mytype then
		return;
	end
	--判断钱
	if player:get_vcoin() < g_month_card_info[type][1] then
		return;
	end
	--扣钱
	player:sub_vcoin(g_month_card_info[type][1]);
	
	local time = os.date("*t",now);
    local today = os.time({year = time.year, month = time.month, day = time.day, hour = 0, min = 0, sec = 0});
    local end_time = today + g_month_card_info[type][2] * 86400 - 1;
	if mytime < now then
		player:alert(10,0,0,"成功获得特权，享受超爽至尊BUFF");
	else
		player:alert(10,0,0,"成功替换新特权，立即获得更强大的至尊BUFF");
	end
	if type ==  2 then
		g_broadcast(12,0,0,"<font color='#00ccff'>"..player:GetName().."</font>购买<font color='#00ccff'>至尊特权卡</font>，杀怪攻击力爆涨<font color='#00ccff'>2000点</font>，每日赠送<font color='#00ccff'>1000绑元</font>，畅享顶级游戏体验。<a href='event:topupmonth'><u><font color='#0be140'>我也要体验</font></u></a>");
	end
	player:set_param(440,type);
	player:set_param(442,end_time);
	player:set_param(443,0);
	player:set_status(g_month_card_info[type][3],end_time - now, 100, 7);
	player:set_status(g_month_card_info[type][4],end_time - now, 100, 7);
	
	local obj = {};
	obj.type  = type;
	obj.time = end_time;	
	obj.reward_flag  = 0;
	if mytime >= now then
		player:set_name_pre(15,"");
		player:set_name_pre(16,"1124");
	else
		if obj.type == 1 then
			player:set_name_pre(15,"1123");
		else
			player:set_name_pre(16,"1124");
		end
	end
	
	local cur = os.time()
	if cur >= end_time then
		obj.effect = 0;
	else
		obj.effect = 1;
	end
	
	player:SendPacketToSelf(4080,0,encode(obj));
end

function OnMonthCardReward(player,type, flag, time, id)
	local nowCfg = g_month_card_reward[type];
	local bag_num = 0;
	local len = #nowCfg;
	for i = 1,len do
		if nowCfg[i][1] == 0 then
			bag_num = bag_num + 1;
		end
	end
	if player:num_bag_black() < bag_num then
		player:alert(10,0,0,"背包空间不足，请及时处理");
		return;
	end
	for i = 1,len do
		new_add_item(player,nowCfg[i][1],nowCfg[i][2],nowCfg[i][3],nowCfg[i][4]);
		if nowCfg[i][1] == 100 then
			player:SendVcoinFly(nowCfg[i][3], 10, 1);
		elseif nowCfg[i][1] == 101 then
			player:SendVcoinFly(nowCfg[i][3], 10, 0);
		end
	end
	player:alert(10,0,0,"成功领取特权奖励");
	player:set_param(443,1);	
	local obj = {};
	obj.type  = type;
	obj.time = time;	
	obj.reward_flag  = 1;
	local cur = os.time()
	if cur >= time then
		obj.effect = 0;
	else
		obj.effect = 1;
	end
	player:SendPacketToSelf(4080,0,encode(obj));
end



--购买材料副本次数
function OnBuyInstanceEnterTime(player, mapid)
	--玩家私人变量值的配置
	local paramConf = {
		[249] = {355},
		[257] = {356},
		[258] = {357},
		[259] = {358},
		[437] = {375},
		[260] = {675},
		[261] = {674},
	}

	--判断是否需要买
	local conf = paramConf[mapid]
	if conf == nil then
		return 
	end

	local todayEnterTime = player:get_param(conf[1])
	if g_mapentern[mapid][1] > todayEnterTime then
		--不需要购买
		local errorMsg = "还有次数,不需要购买副本次数"
		player:alert(10,0,0,errorMsg)
		return 
	end

	--判断购买是否次数是否达到上限
	local todayBuyTime = player:get_task_param(conf[1],0)
	local buyConf = g_buymapentertime[mapid]
	if buyConf == nil then
		return 
	end

	if todayBuyTime >= buyConf.daylimit then
		local errorMsg = "今日购买次数已用完"
		player:alert(10,0,0,errorMsg)
		return
	end

	--判断钱是否足够
	local has = player:NewGetGold(buyConf.consumetype)
	if has < buyConf.consume then
		local notifyMsg = {
			[1] = "金币不足,不能购买",
			[2] = "绑金不足,不能购买",
			[3] = "元宝不足,不能购买",
			[4] = "绑元不足,不能购买",
		}

		local errorMsg = notifyMsg[buyConf.consumetype + 1]
		player:alert(10,0,0,errorMsg)
		return 
	end

	--扣钱
	player:NewDeductGold(buyConf.consumetype, buyConf.consume, 93)

	player:set_task_param(conf[1],0, todayBuyTime + 1)
	player:set_param(conf[1], todayEnterTime - 1)

	--返回2445协议
	OnGetFuBenNum(player)
end


--校验是否可以购买并使用物品
function CheckCanBuyAndUseItem(player, itemid)
	local config = {
		[10153] = {useParam = 612}, --宝石碎片(小)
		[10154] = {useParam = 613}, --宝石碎片(中)
		[10151] = {useParam = 610}, --魂珠碎片(小)
		[10152] = {useParam = 611}, --魂珠碎片(中)
		[10246] = {useParam = 619}, --高级转生丹
		[10247] = {useParam = 620}, --超级转生丹
		[10163] = {useParam = 625},
		[10164] = {useParam = 626},
		[31301] = {useParam = 623}, --boss积分精魂
	}
	local bFlag = 1
	if config[itemid] then
		local useParam = config[itemid].useParam
		local todayUse = player:get_param(useParam)
		local vipLevel = player:get_player_type()
		local useLimit = VipLimit.itemUseLimit[itemid] and VipLimit.itemUseLimit[itemid][vipLevel + 1] or 1
		if todayUse >= useLimit then
			bFlag = 0
		end
	end

	return bFlag
end

function OnQQSpaceReward(player,type,id)
	if type == 1 then
		if player:get_param(240) == 1 then
			return;
		end
		local bag_num = 0;
		local qqspace = g_QQSpaceReward[type];
		if qqspace == nil then
			return;
		end
		for i=1,#qqspace do
			if qqspace[i][3] == 0 then
				bag_num = bag_num + qqspace[i][2];
			else
				bag_num = bag_num + 1;
			end
		end		
		if player:num_bag_black() < bag_num then
			player:alert(10,0,0,"背包空间不足，请及时清理");
			return;
		end
		player:set_param(240,1);
		for i=1,#qqspace do
			player:add_item(qqspace[i][1],qqspace[i][2],1,0,0,0);
		end
	elseif type == 2 then
		local param = player:get_param(241);
		if bitget(param,id) == 1 then
			return;
		end			
		if g_QQSpaceReward[type][id] == nil then
			return;
		end
		local level = player:GetLevel();
		if level < g_QQSpaceReward[type][id][1] then
			player:alert(10,0,0,"等级不足，不能领取礼包");
			return;
		end
		local bag_num = 0;
		local qqspace = g_QQSpaceReward[type][id][2];
		if qqspace == nil then
			return;
		end
		for i=1,#qqspace do
			if qqspace[i][3] == 0 then
				bag_num = bag_num + qqspace[i][2];
			else
				bag_num = bag_num + 1;
			end
		end		
		if player:num_bag_black() < bag_num then
			player:alert(10,0,0,"背包空间不足，请及时清理");
			return;
		end
		player:set_param(241,bitset(param,id));
		for i=1,#qqspace do
			player:add_item(qqspace[i][1],qqspace[i][2],1,0,0,0);
		end
	elseif type == 3 then
		if player:get_param(242) == 1 then
			return;
		end
		local bag_num = 0;
		local qqspace = g_QQSpaceReward[type];
		if qqspace == nil then
			return;
		end
		for i=1,#qqspace do
			if qqspace[i][3] == 0 then
				bag_num = bag_num + qqspace[i][2];
			else
				bag_num = bag_num + 1;
			end
		end		
		if player:num_bag_black() < bag_num then
			player:alert(10,0,0,"背包空间不足，请及时清理");
			return;
		end
		player:set_param(242,1);
		for i=1,#qqspace do
			player:add_item(qqspace[i][1],qqspace[i][2],1,0,0,0);
		end
	end
end

function OnQQHallReward(player,type,id)
	if type == 1 then
		if player:get_param(251) == 1 then
			return;
		end
		local bag_num = 0;
		local qqhall = g_QQHallReward[type];
		if qqhall == nil then
			return;
		end
		for i=1,#qqhall do
			if qqhall[i][3] == 0 then
				bag_num = bag_num + qqhall[i][2];
			else
				bag_num = bag_num + 1;
			end
		end		
		if player:num_bag_black() < bag_num then
			player:alert(10,0,0,"背包空间不足，请及时清理");
			return;
		end
		player:set_param(251,1);
		for i=1,#qqhall do
			player:add_item(qqhall[i][1],qqhall[i][2],1,0,0,0);
		end
	elseif type == 2 then
		local param = player:get_param(252);
		if bitget(param,id) == 1 then
			return;
		end			
		if g_QQHallReward[type][id] == nil then
			return;
		end
		local level = player:GetLevel();
		if level < g_QQHallReward[type][id][1] then
			player:alert(10,0,0,"等级不足，不能领取礼包");
			return;
		end
		local bag_num = 0;
		local qqhall = g_QQHallReward[type][id][2];
		if qqhall == nil then
			return;
		end
		for i=1,#qqhall do
			if qqhall[i][3] == 0 then
				bag_num = bag_num + qqhall[i][2];
			else
				bag_num = bag_num + 1;
			end
		end		
		if player:num_bag_black() < bag_num then
			player:alert(10,0,0,"背包空间不足，请及时清理");
			return;
		end
		player:set_param(252,bitset(param,id));
		for i=1,#qqhall do
			player:add_item(qqhall[i][1],qqhall[i][2],1,0,0,0);
		end
	elseif type == 3 then
		if player:get_param(253) == 1 then
			return;
		end
		local bag_num = 0;
		local qqhall = g_QQHallReward[type];
		if qqhall == nil then
			return;
		end
		for i=1,#qqhall do
			if qqhall[i][3] == 0 then
				bag_num = bag_num + qqhall[i][2];
			else
				bag_num = bag_num + 1;
			end
		end		
		if player:num_bag_black() < bag_num then
			player:alert(10,0,0,"背包空间不足，请及时清理");
			return;
		end
		player:set_param(253,1);
		for i=1,#qqhall do
			player:add_item(qqhall[i][1],qqhall[i][2],1,0,0,0);
		end
	end
end

function OnInitGuildShop(player,type)
	local special = 0;
	if type == 1 then
		local now_money = player:get_vcoin();
		if now_money < g_GuildShop["money"] then
			player:alert(10,0,0,"元宝不足");
			return;			
		end
		local totaltimes = g_get_param(46) + 1;
		if totaltimes > g_special_GuildShop["times"] then
			g_set_param(46,0);
			special = 1;
		else
			g_set_param(46,totaltimes);
		end
		player:sub_vcoin(g_GuildShop["money"]);
		--player:alert(2,0,0,"全服刷新次数："..totaltimes);
	end
	
	local obj = {};
	for i=1,4 do
		local guildshop = g_GuildShop[i];
		if special == 1 and i == 1 then
			guildshop = g_special_GuildShop[player:get_param(258)];
			if guildshop == nil then
				guildshop = g_special_GuildShop[0];
			end
		end
		local target = {};
		target.id = i;
		local rate = guildshop[1];
		local index = math.random(0,rate - 1);
		for j=1,#g_GuildShop[i][2] do
			if  index < guildshop[2][j][6] then
				target.itemid = guildshop[2][j][1];
				target.stack  = guildshop[2][j][2];
				target.type   = guildshop[2][j][3];
				target.gold   = guildshop[2][j][4];
				target.band   = guildshop[2][j][5];
				target.flag   = 0;
				target.oldgold= guildshop[2][j][7];
				target.limit  = guildshop[2][j][8];
				break;
			end
		end
		if special == 1 and i == 1 then
			target.flag = 1;
	--		g_broadcast(12,0,0,"恭喜<font color='#00ccff'>"..player:GetName().."</font>运气逆天，获得百里挑一的机会，在公会商店刷出了{_equip,"..target.itemid.."}！！");
		end
		table.insert(obj,target);
    end
    player:set_param(228,g_GuildShop["update"] + os.time());
    local shop = g_GuildShop;
    if special == 1 then
    	shop = g_special_GuildShop;
    end

    player:InitGuildShop(encode(obj),shop["item"][1],shop["item"][2],shop["item"][3],shop["item"][4]);
end

function OnGPB(player,entry)
	if g_PB_config[entry] == nil then
		player:alert(2,0,0,"缺少采集配置："..entry);
		return;
	end
	local conf = g_PB_config[entry];
	local rate = math.random(1,conf["weight"]);
	for i=1,#conf["items"] do
		local item = conf["items"][i];
		if item[3] >= rate then
			player:add_item(item[1],item[2],item[5],0,0,0);
			player:alert(20,0,0,"抓捕成功，获得"..item[4]);
			return;
		end
	end
	player:alert(20,0,0,"抓捕成功");
	
	if player:GetMapId() == 502 then
		player:set_param(214,player:get_param(214) + 1);
		OnTravelSnatch(player,0);
	end
end

function OnTravelSnatch(player,type)
	local action213,misc213 = player:get_param_all_info(213);
	local action214,misc214 = player:get_param_all_info(214);
	
	if type > 0 then
		local action,misc,conf;
		if type == 1 then
			action = action213;
			misc = misc213 + 1;
			misc213 = misc;
			conf = g_travel_snatch_kill[misc];
		elseif type == 2 then
			action = action214;
			misc = misc214 + 1;
			misc214 = misc;
			conf = g_travel_snatch_collect[misc]
		end
		if conf == nil then
			player:alert(21,0,0,"领取奖励档次错误");
			return;
		end
		if action < conf.total then
			player:alert(21,0,0,"任务未完成");
			return;
		end
		player:alert(20,0,0,"奖励已通过邮件发送，回本服可领取");
		player:set_param_misc(212 + type,misc);
		local award = conf.award;
		local items = "";
		local itembind = "";
		local mailmessage = "这是您在赤月峡谷活动中完成";
		for i=1,#award do
			items = items..award[i][1]..","..award[i][2].."|";
			itembind = itembind..award[i][3].."|";
		end
		if type == 1 then
			mailmessage = mailmessage.."累计击杀"..conf.total.."只怪物";
		else
			mailmessage = mailmessage.."累计抓捕"..conf.total.."只八珍猪";
		end
		mailmessage = mailmessage.."的任务奖励，请查收!";
		player:send_travel_mail(items,itembind,mailmessage);
	end
	
	local objtbl = {};
	objtbl.list = {};
	local target = {};
	
	target.id = 1;
	if g_travel_snatch_kill[misc213 + 1] ~= nil then
		target.index = misc213 + 1;
		target.total = g_travel_snatch_kill[misc213 + 1].total;
		target.num   = action213;
	else
		target.index = 0;
		target.total = 0;
		target.num = 0;
	end
	table.insert(objtbl.list,target);
	
	target = {};
	target.id = 2;
	if g_travel_snatch_collect[misc214 + 1] ~= nil then
		target.index = misc214 + 1;
		target.total = g_travel_snatch_collect[misc214 + 1].total;
		target.num   = action214;
	else
		target.index = 0;
		target.total = 0;
		target.num = 0;
	end
	table.insert(objtbl.list,target);
	player:SendPacketToSelf(3315,0,encode(objtbl));
end
